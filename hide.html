<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Hide — Maintenance Console</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#000;--fg:#7CFC00;--muted:#555}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace}
    .wrap{display:flex;height:100vh}
    .left{flex:1;padding:20px;box-sizing:border-box;border-right:1px solid #222}
    .right{width:420px;background:#050505;padding:12px;box-sizing:border-box;overflow:auto}
    h1{font-size:18px;margin:0 0 12px}
    .controls{display:flex;gap:8px;margin:12px 0}
    button.cmd{background:#111;color:var(--fg);border:1px solid #333;padding:8px 12px;border-radius:4px;cursor:pointer}
    .console{background:#000;border:1px solid #111;padding:12px;height:calc(100% - 120px);overflow:auto}
    .line{white-space:pre-wrap;font-size:13px}
    .section{margin-bottom:16px}
    .progressWrap{background:#111;border:1px solid #222;padding:6px;border-radius:6px;margin-top:8px}
    .bar{height:12px;background:#222;border-radius:6px;overflow:hidden}
    .barInner{height:100%;background:linear-gradient(90deg,#00FF66,#00AA44);width:0%}
    .miniLog{font-size:12px;color:var(--muted);margin-top:8px}
    .fileInput{display:none}
    .note{color:var(--muted);font-size:12px;margin-top:4px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="left">
      <h1>Boot Console — Hide Mode</h1>
      <div class="controls">
        <button class="cmd" id="backupBtn">Backup (Export XML)</button>
        <label class="cmd" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer"><input id="filePicker" class="fileInput" type="file" accept=".xml"><span>Load Previous (Import XML)</span></label>
        <button class="cmd" id="restoreBtn">Restore from chosen file</button>
      </div>

      <div class="section">
        <div class="line">System booting... initializing hide console</div>
        <div class="progressWrap">
          <div class="bar"><div id="usersBar" class="barInner" style="width:0%"></div></div>
          <div class="miniLog" id="usersLog">Users: waiting...</div>
        </div>
        <div class="progressWrap">
          <div class="bar"><div id="publicBar" class="barInner" style="width:0%"></div></div>
          <div class="miniLog" id="publicLog">Public chat: waiting...</div>
        </div>
        <div class="progressWrap">
          <div class="bar"><div id="privateBar" class="barInner" style="width:0%"></div></div>
          <div class="miniLog" id="privateLog">Private DMs: waiting...</div>
        </div>
        <div class="progressWrap">
          <div class="bar"><div id="threadsBar" class="barInner" style="width:0%"></div></div>
          <div class="miniLog" id="threadsLog">Threads: waiting...</div>
        </div>
      </div>

      <div class="note">When running backup or restore you will see verbose mini-log entries on the right. Use the Restore action with caution; it will attempt to POST items back to server endpoints or fall back to localStorage.</div>
    </div>
    <div class="right">
      <h2 style="margin:0 0 8px">Process Log</h2>
      <div id="processLog" class="console"></div>
    </div>
  </div>

<script>
(async function(){
  const API = 'https://chat-backend-pdzh.onrender.com';
  const logEl = document.getElementById('processLog');
  const filePicker = document.getElementById('filePicker');
  function appendLog(t){ const d=document.createElement('div'); d.className='line'; d.innerText = '> '+t; logEl.appendChild(d); logEl.scrollTop = logEl.scrollHeight; }

  function setBar(id, pct){ document.getElementById(id).style.width = Math.max(0,Math.min(100,pct))+'%'; }

  async function tryFetchJson(url){ try{ const r=await fetch(url); if(!r.ok) throw new Error('Status '+r.status); return await r.json(); }catch(e){ appendLog('ERR '+url+' -> '+e.message); return null; } }

  async function gatherBackup(){
    appendLog('Starting backup...');
    // 1) users
    appendLog('Fetching users...');
    const users = await tryFetchJson(API+'/users') || [];
    setBar('usersBar', 20);
    document.getElementById('usersLog').innerText = `Users: found ${users.length}`;
    users.forEach((u,i)=> appendLog(`Loaded User '${u.username || u.name || 'unknown'}' With password '${u.password || u.hash || 'N/A'}'`));

    // 2) public chat (/log)
    appendLog('Fetching public chat log...');
    const publicLog = await tryFetchJson(API+'/log') || [];
    setBar('publicBar', 40);
    document.getElementById('publicLog').innerText = `Public messages: ${publicLog.length}`;
    publicLog.forEach((m,i)=> appendLog(`Loaded public msg by '${(m.from||m.split||'?')}'`));

    // 3) threads
    appendLog('Fetching threads list...');
    const threads = await tryFetchJson(API+'/threads') || [];
    setBar('threadsBar', 60);
    document.getElementById('threadsLog').innerText = `Threads: ${threads.length}`;
    threads.forEach(t => appendLog(`Loaded thread '${t.title || t.id}' by ${t.creator||'?'}`));

    // 4) private DMs: try /pms or iterate users pairs
    appendLog('Attempting to fetch private DMs...');
    let pmsAll = null;
    pmsAll = await tryFetchJson(API+'/pms') || await tryFetchJson(API+'/private') || await tryFetchJson(API+'/allpms');
    if (pmsAll && Array.isArray(pmsAll)){
      setBar('privateBar', 90);
      document.getElementById('privateLog').innerText = `Private DMs: ${pmsAll.length}`;
      pmsAll.forEach(d=> appendLog(`Loaded DM from '${d.from}' to '${d.to}' ts:${d.ts||''}`));
    } else {
      // fallback: iterate user pairs (may be heavy)
      const collected = [];
      for (let i=0;i<users.length;i++){
        for (let j=0;j<users.length;j++){
          if (i===j) continue;
          const a = users[i].username || users[i].name;
          const b = users[j].username || users[j].name;
          if (!a||!b) continue;
          const url = `${API}/pm/${encodeURIComponent(a)}/${encodeURIComponent(b)}`;
          const d = await tryFetchJson(url);
          if (d && Array.isArray(d) && d.length){ d.forEach(m=> collected.push({from:a,to:b,ts:m.ts||'',message:m.message||m})); appendLog(`Loaded ${d.length} DM(s) ${a}->${b}`); }
        }
        setBar('privateBar', Math.round((i+1)/users.length*90));
      }
      document.getElementById('privateLog').innerText = `Private DMs (collected): ${collected.length}`;
      pmsAll = collected;
    }

    // Build XML
    appendLog('Building XML...');
    function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    let xml = '<?xml version="1.0" encoding="utf-8"?>\n<backup>\n';
    xml += '<users>\n';
    users.forEach(u=> xml += `<user username="${esc(u.username||u.name||'')}">`+esc(u.password||u.hash||'')+`</user>\n`);
    xml += '</users>\n';
    xml += '<public>\n';
    publicLog.forEach(item=>{
      if (typeof item === 'string'){
        xml += `<msg ts="">${esc(item)}</msg>\n`;
      } else if (item.from && (item.message || item.msg || item.text)){
        const txt = item.message||item.text||item.msg||'';
        const ts = item.ts||'';
        xml += `<msg ts="${esc(ts)}" user="${esc(item.from)}">${esc(txt)}</msg>\n`;
      }
    });
    xml += '</public>\n';
    xml += '<threads>\n';
    threads.forEach(t=>{
      xml += `<thread id="${esc(t.id||t.title)}" title="${esc(t.title||'')}">`+esc(JSON.stringify(t))+'</thread>\n';
    });
    xml += '</threads>\n';
    xml += '<private>\n';
    if (Array.isArray(pmsAll)){
      pmsAll.forEach(d=>{
        if (d.from && d.to) xml += `<dm from="${esc(d.from)}" to="${esc(d.to)}" ts="${esc(d.ts||'')}">${esc(d.message||d.msg||'')}</dm>\n`;
        else if (d.from && d.message) xml += `<dm from="${esc(d.from)}" to="" ts="${esc(d.ts||'')}">${esc(d.message||'')}</dm>\n`;
      });
    }
    xml += '</private>\n</backup>';

    setBar('usersBar',100); setBar('publicBar',100); setBar('threadsBar',100); setBar('privateBar',100);
    appendLog('XML built. Preparing download...');
    const blob = new Blob([xml], {type:'application/xml'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `backup-${Date.now()}.xml`; a.click();
    appendLog('Download triggered. Backup complete.');
  }

  async function restoreFromFile(file){
    if(!file) { appendLog('No file selected'); return; }
    appendLog('Reading file '+file.name);
    const txt = await file.text();
    const dom = new DOMParser().parseFromString(txt,'application/xml');
    // users
    const users = Array.from(dom.querySelectorAll('backup>users>user'));
    appendLog(`Restoring ${users.length} users...`);
    for (let i=0;i<users.length;i++){
      const el = users[i];
      const username = el.getAttribute('username') || el.textContent || '';
      const passwd = el.textContent || '';
      appendLog(`Restoring user '${username}' with password '${passwd}'`);
      try{
        // Try server endpoints then localStorage
        let ok=false;
        try{ const r = await fetch(API+'/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,password:passwd})}); if(r.ok) ok=true; }catch(e){}
        if(!ok){ try{ const r2 = await fetch(API+'/users',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,password:passwd})}); if(r2.ok) ok=true;}catch(e){} }
        if(!ok){ // local fallback
          const local = JSON.parse(localStorage.getItem('localUsers')||'[]');
          if(!local.find(u=>u.username===username)) local.push({username,password:passwd,isAdmin:false});
          localStorage.setItem('localUsers',JSON.stringify(local));
          appendLog(`Stored user '${username}' in localUsers`);
        } else appendLog(`Server accepted user '${username}'`);
      }catch(e){ appendLog('ERR restore user '+e.message); }
      setBar('usersBar', Math.round((i+1)/users.length*100));
    }

    // public messages
    const msgs = Array.from(dom.querySelectorAll('backup>public>msg'));
    appendLog(`Restoring ${msgs.length} public messages...`);
    for (let i=0;i<msgs.length;i++){
      const m = msgs[i];
      const ts = m.getAttribute('ts')||'';
      const user = m.getAttribute('user')||'';
      const text = m.textContent||'';
      appendLog(`Posting public msg from '${user}' ts='${ts}'`);
      try{ await fetch(API+'/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user:user,message:text,ts:ts})}); }
      catch(e){ appendLog('ERR post public '+e.message); }
      setBar('publicBar', Math.round((i+1)/msgs.length*100));
    }

    // threads (best-effort)
    const threads = Array.from(dom.querySelectorAll('backup>threads>thread'));
    appendLog(`Attempting to restore ${threads.length} threads...`);
    for (let i=0;i<threads.length;i++){
      const t = threads[i];
      try{ const payload = JSON.parse(t.textContent||'{}'); await fetch(API+'/threads',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); appendLog(`Posted thread ${t.getAttribute('title')||t.getAttribute('id')}`);}catch(e){ appendLog('ERR thread '+e.message); }
      setBar('threadsBar', Math.round((i+1)/threads.length*100));
    }

    // private dms
    const dms = Array.from(dom.querySelectorAll('backup>private>dm'));
    appendLog(`Restoring ${dms.length} private dms...`);
    for (let i=0;i<dms.length;i++){
      const d = dms[i];
      const from = d.getAttribute('from')||''; const to = d.getAttribute('to')||''; const ts = d.getAttribute('ts')||''; const text = d.textContent||'';
      appendLog(`Posting DM ${from} -> ${to} ts:${ts}`);
      try{ await fetch(API+'/pm',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({from,to,message:text,ts})}); }
      catch(e){ appendLog('ERR post dm '+e.message); }
      setBar('privateBar', Math.round((i+1)/dms.length*100));
    }

    appendLog('Restore complete.');
  }

  document.getElementById('backupBtn').onclick = gatherBackup;
  document.getElementById('restoreBtn').onclick = ()=>{
    const f = filePicker.files && filePicker.files[0];
    if(!f) appendLog('No file selected to restore'); else restoreFromFile(f);
  };
  filePicker.onchange = ()=>{ appendLog('File selected: '+(filePicker.files[0]&&filePicker.files[0].name||'')); };

  appendLog('Hide console ready.');
})();
</script>
</body>
</html>
