<!DOCTYPE html>
<html>
<head>
  <title>AlexNET</title>
  <style>
    body { font-family: sans-serif; display: flex; gap: 20px; }
    #main { flex: 1; }
    #sidebar {
      width: 200px;
      border-left: 1px solid #ccc;
      padding-left: 10px;
    }
    .rank-Sigmer {
      font-weight: bold;
      background: linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet);
      -webkit-background-clip: text;
      color: transparent;
    }
    .rank-OG {
      color: gold;
      font-weight: bold;
    }
    .rank-Bloody {
      color: darkred;
      font-weight: bold;
    }
    .rank-ADMIN {
      font-weight: bold;
      background: linear-gradient(270deg, red, orange, yellow, green, blue, indigo, violet);
      background-size: 400% 400%;
      -webkit-background-clip: text;
      color: transparent;
      animation: rainbowMove 5s infinite linear;
    }
    @keyframes rainbowMove {
      0% { background-position: 0% 50%; }
      100% { background-position: 100% 50%; }
    }
    #chatBox {
      white-space: pre-wrap;
      border: 1px solid #ccc;
      height: 300px;
      overflow-y: scroll;
      padding: 10px;
      margin-bottom: 10px;
    }
    #adminControls button {
      margin-right: 5px;
    }
    .userEntry {
      margin-bottom: 8px;
    }
    .userEntry button {
      margin-left: 5px;
      font-size: 10px;
    }
  </style>
</head>
<body>
  <div id="main">
    <h2>Welcome, <span id="username"></span></h2>
    <div id="chatBox"></div>
    <input type="text" id="message" placeholder="AChat Message">
    <button onclick="sendMessage()">Send AlexChat Message</button>

    <div id="adminControls" style="margin-top:10px; display:none;">
      <button onclick="adminAction('clear')">Clear</button>
      <button onclick="adminAction('pause')">Pause</button>
      <button onclick="adminAction('unpause')">Unpause</button>
      <button onclick="adminAction('off')">Off</button>
      <button onclick="adminAction('on')">On</button>
      <button onclick="openStats()">Stats</button>
    </div>
  </div>

  <div id="sidebar">
    <h3>Users</h3>
    <div id="userList"></div>
  </div>

  <script>
    const user = localStorage.getItem('chatUser');
    const isAdmin = localStorage.getItem('isAdmin') === 'true';
    const backend = 'https://chat-backend-pdzh.onrender.com';

    if (!user) location.href = 'index.html';
    document.getElementById('username').innerText = user;
    if (isAdmin) document.getElementById('adminControls').style.display = 'block';

    function openStats() {
      window.open('stats.html', '_blank');
    }

    async function loadChat() {
      const [logRes, ranksRes, bannedRes] = await Promise.all([
        fetch(`${backend}/log`),
        fetch(`${backend}/ranks.json`),
        fetch(`${backend}/blacklist.json`)
      ]);
      const log = await logRes.json();
      const ranks = await ranksRes.json();
      const banned = await bannedRes.json();

      const box = document.getElementById('chatBox');
      const userList = document.getElementById('userList');
      box.innerHTML = '';
      userList.innerHTML = '';

      const seenUsers = new Set();

      log.forEach(line => {
        const span = document.createElement('span');

        if (line.includes('>>')) {
          const [rawUser, message] = line.split('>>');
          const sender = rawUser.trim();
          seenUsers.add(sender);
          const userRanks = ranks[sender] || [];

          const rankSpan = userRanks.map(rank => {
            const safeRank = rank.replace(/\s+/g, '-');
            return `<span class="rank-${safeRank}">${rank}</span>`;
          }).join(' ');

          span.innerHTML = `${rankSpan}-${sender}>> ${message}`;
        } else {
          span.innerText = line;
          span.style.color = 'gray';
          span.style.fontStyle = 'italic';
        }

        box.appendChild(span);
        box.appendChild(document.createElement('br'));
      });

      seenUsers.forEach(name => {
        const entry = document.createElement('div');
        entry.className = 'userEntry';

        const userRanks = ranks[name] || [];
        const rankSpan = userRanks.map(rank => {
          const safeRank = rank.replace(/\s+/g, '-');
          return `<span class="rank-${safeRank}">${rank}</span>`;
        }).join(' ');

        entry.innerHTML = `${rankSpan} ${name}`;

        if (isAdmin) {
          const banBtn = document.createElement('button');
          banBtn.innerText = 'Ban';
          banBtn.onclick = () => adminCommand('ban', name);

          const unbanBtn = document.createElement('button');
          unbanBtn.innerText = 'Unban';
          unbanBtn.onclick = () => adminCommand('unban', name);

          entry.appendChild(banBtn);
          entry.appendChild(unbanBtn);
        }

        userList.appendChild(entry);
      });

      const status = await fetch(`${backend}/status`).then(r => r.json());
      if (status.off && !isAdmin) location.href = 'off.html';

      if (banned.includes(user)) {
        alert('You are banned.');
        location.href = 'Loginscreen.html';
      }

      const warn = await fetch(`${backend}/warn/${encodeURIComponent(user)}`).then(r => r.json());
      if (warn.reason) location.href = 'warn.html';
    }

    async function sendMessage() {
      const msg = document.getElementById('message').value.trim();
      if (!msg) return;

      if (isAdmin && msg.startsWith('/')) {
        const [cmd, arg, ...rest] = msg.split(' ');
        const payload = { user: arg, reason: arg, message: rest.join(' ') };

        if (cmd === '/ban') {
          await fetch(`${backend}/ban`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        } else if (cmd === '/unban') {
          await fetch(`${backend}/unban`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        } else if (cmd === '/warn') {
          await fetch(`${backend}/warn`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        } else if (cmd === '/del') {
          await fetch(`${backend}/del`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ line: parseInt(arg) })
          });
        }
      } else {
        await fetch(`${backend}/send`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user, message: msg })
        });
      }

      document.getElementById('message').value = '';
      loadChat();
    }

    async function adminAction(action) {
      await fetch(`${backend}/${action}`, { method: 'POST' });
      loadChat();
    }

    async function adminCommand(type, target) {
      await fetch(`${backend}/${type}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user: target })
      });
      loadChat();
    }

    setInterval(loadChat, 2000);
    loadChat();
  </script>
</body>
</html>
