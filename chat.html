<!DOCTYPE html>
<html>
<head>
  <title>AlexNET</title>
  <style>
    body { font-family: sans-serif; display: flex; gap: 20px; margin:0; padding:20px; }
    #main { flex: 1; }
    #sidebar {
      width: 200px;
      border-left: 1px solid #ccc;
      padding-left: 10px;
    }
    #chatBox {
      white-space: pre-wrap;
      border: 1px solid #ccc;
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 10px;
    }
    input#message { width: calc(100% - 110px); padding: 5px; }
    button { padding: 5px 10px; margin: 5px 0; cursor: pointer; }
    .emoji { font-size: 20px; cursor: pointer; margin: 5px; display: inline-block; }

    .rank-Sigmer { /* â€¦gradient textâ€¦ */ }
    .rank-OG    { color: gold; font-weight: bold; }
    .rank-Bloody{ color: darkred; font-weight: bold; }
    .rank-ADMIN { /* â€¦rainbow animatedâ€¦ */ }

    .userEntry { margin-bottom: 8px; }
    .userEntry button { font-size: 10px; margin-left: 5px; }
  </style>
</head>
<body>
  <div id="main">
    <h2>Welcome, <span id="username"></span></h2>

    <div id="chatBox"></div>

    <div>
      <input type="text" id="message" placeholder="AChat Message">
      <button onclick="sendMessage()">Send</button>
      <button onclick="toggleEmojiBoard()">ðŸ˜€ Emoji Board</button>
    </div>

    <div id="emojiBoard" style="display:none;"></div>

    <div id="adminControls" style="margin-top:10px; display:none;">
      <button onclick="adminAction('clear')">Clear</button>
      <button onclick="adminAction('pause')">Pause</button>
      <button onclick="adminAction('unpause')">Unpause</button>
      <button onclick="adminAction('off')">Off</button>
      <button onclick="adminAction('on')">On</button>
      <button onclick="openStats()">Stats</button>
    </div>
  </div>

  <div id="sidebar">
    <h3>Users</h3>
    <div id="userList"></div>
  </div>

  <script>
    const backend = 'https://chat-backend-pdzh.onrender.com';
    const user    = localStorage.getItem('chatUser');
    const isAdmin = localStorage.getItem('isAdmin') === 'true';

    if (!user) location.href = 'index.html';
    document.getElementById('username').innerText = user;
    if (isAdmin) document.getElementById('adminControls').style.display = 'block';

    function openStats() {
      window.open('stats.html', '_blank');
    }

    function toggleEmojiBoard() {
      const board = document.getElementById('emojiBoard');
      board.style.display = board.style.display === 'none' ? 'block' : 'none';
      if (!board.hasChildNodes()) {
        const emojis = ['ðŸ˜€','ðŸ˜‚','ðŸ˜Ž','ðŸ˜','ðŸ˜¢','ðŸ˜¡','ðŸ‘','ðŸ‘Ž','ðŸ”¥','ðŸ’¯','ðŸŽ‰','ðŸ¤–','ðŸ§ ','ðŸš€','â¤ï¸'];
        emojis.forEach(e => {
          const span = document.createElement('span');
          span.className = 'emoji';
          span.innerText = e;
          span.onclick = () => {
            const inp = document.getElementById('message');
            inp.value += e;
            inp.focus();
          };
          board.appendChild(span);
        });
      }
    }

    async function loadChat() {
      const [logRes, ranksRes, banRes, statusRes, warnRes] = await Promise.all([
        fetch(`${backend}/log`).then(r => r.json()),
        fetch(`${backend}/ranks.json`).then(r => r.json()),
        fetch(`${backend}/blacklist.json`).then(r => r.json()),
        fetch(`${backend}/status`).then(r => r.json()),
        fetch(`${backend}/warn/${encodeURIComponent(user)}`).then(r => r.text())
      ]);

      // If OFF and not GOD HIMSELF â†’ kick out
      if (statusRes.off && user !== 'GOD HIMSELF') {
        return location.href = 'off.html';
      }

      // If banned â†’ kick
      if (banRes.includes(user)) {
        alert('You are banned.');
        return location.href = 'index.html';
      }

      // If this user is warned â†’ show warn page
      if (warnRes) {
        localStorage.setItem('warnMessage', warnRes);
        return location.href = 'warn.html';
      }

      const box = document.getElementById('chatBox');
      const userList = document.getElementById('userList');
      box.innerHTML = '';
      userList.innerHTML = '';

      const seen = new Set();

      // Render chat log
      logRes.forEach(line => {
        const span = document.createElement('span');
        if (line.includes('>>')) {
          const [rawUser, msg] = line.split('>>');
          const sender = rawUser.trim();
          seen.add(sender);
          const rankSpan = (ranksRes[sender] || [])
            .map(r => `<span class="rank-${r.replace(/\s+/g,'-')}">${r}</span>`)
            .join(' ');
          span.innerHTML = `${rankSpan}-${sender}>> ${msg}`;
        }
        else if (line.startsWith('<<') && line.endsWith('>>')) {
          span.innerText = line;
          span.style.color = 'gray';
          span.style.fontStyle = 'italic';
        }
        else {
          span.innerText = line;
        }
        box.appendChild(span);
        box.appendChild(document.createElement('br'));
      });

      // Sidebar user list
      seen.forEach(name => {
        const div = document.createElement('div');
        div.className = 'userEntry';
        const rankSpan = (ranksRes[name] || [])
          .map(r => `<span class="rank-${r.replace(/\s+/g,'-')}">${r}</span>`)
          .join(' ');
        div.innerHTML = `${rankSpan} ${name}`;

        if (isAdmin) {
          const banBtn   = Object.assign(document.createElement('button'), { innerText:'Ban'  });
          const unbanBtn = Object.assign(document.createElement('button'), { innerText:'Unban' });
          banBtn.onclick   = () => adminCommand('ban',   name);
          unbanBtn.onclick = () => adminCommand('unban', name);
          div.appendChild(banBtn);
          div.appendChild(unbanBtn);
        }

        userList.appendChild(div);
      });
    }

    async function sendMessage() {
      const msg = document.getElementById('message').value.trim();
      if (!msg) return;

      if (isAdmin && msg.startsWith('/')) {
        const [cmd, target, ...rest] = msg.split(' ');
        const url = cmd.slice(1);
        const payload = url === 'warn'
          ? { user: target, reason: rest.join(' ') }
          : { user: target };

        await fetch(`${backend}/${url}`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
      } else {
        await fetch(`${backend}/send`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ user, message: msg })
        });
      }
      document.getElementById('message').value = '';
      loadChat();
    }

    async function adminAction(action) {
      await fetch(`${backend}/${action}`, { method:'POST' });
      loadChat();
    }

    async function adminCommand(cmd, target) {
      const payload = cmd === 'warn'
        ? { user: target, reason: prompt(`Reason to warn ${target}?`) || '' }
        : { user: target };
      await fetch(`${backend}/${cmd}`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      loadChat();
    }

    setInterval(loadChat, 2000);
    loadChat();
  </script>
</body>
</html>
