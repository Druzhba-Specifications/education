<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AlexNET Chat</title>
  <style>
    /* THEME VARIABLES */
    :root {
      --sidebar-bg: #f5f5f5;
      --main-bg:    #ffffff;
      --chat-bg:    #fafafa;
      --text-color: #000000;
      --font-size:  14px;
    }

    /* RESET & LAYOUT */
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      font-family: sans-serif;
      background: var(--main-bg);
      color: var(--text-color);
      font-size: var(--font-size);
    }

    /* SIDEBAR */
    #sidebar {
      width: 200px;
      background: var(--sidebar-bg);
      border-right: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
    }
    .rank-Egg { color: black; font-weight: bold; }
    .rank-test_rank_for_admins { color: rgb(85, 16, 76); font-weight: bold; } 
    .rank-Sigmer { 
      font-weight: bold; 
      background: linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet); 
      -webkit-background-clip: text; 
      background-clip: text;
      color: transparent; 
    } 
    .rank-DOMINATOR { 
      font-weight: bold; 
      background: linear-gradient(to right, blue, purple, green); 
      -webkit-background-clip: text; 
      background-clip: text;
      color: transparent; 
    } 
    .rank-Chopped { 
      font-weight: bold; 
      background: linear-gradient(to right, red, black, darkblue, blue, yellow, darkred, violet); 
      -webkit-background-clip: text; 
      background-clip: text;
      color: transparent; 
    } 
    .rank-Sunburnt { 
      font-weight: bold; 
      background: linear-gradient(to right, black, darkred, red, hotpink, orange, yellow); 
      -webkit-background-clip: text; 
      background-clip: text;
      color: transparent; 
    } 
    .rank-Discorder { 
      font-weight: bold; 
      background: linear-gradient(to right, blue, darkblue, indigo, #682860, violet); 
      -webkit-background-clip: text; 
      background-clip: text;
      color: transparent; 
    } 
    .rank-BEAN { 
      font-weight: bold; 
      background: linear-gradient(to right, black, #B7410E, brown, orange, yellow); 
      -webkit-background-clip: text; 
      background-clip: text;
      color: transparent; 
    }
    .rank-OG { color: gold; font-weight: bold; } 
    .rank-Bloody { color: darkred; font-weight: bold; } 
    .rank-ADMIN { 
      font-weight: bold; 
      background: linear-gradient(270deg, red, orange, yellow, green, blue, indigo, violet); background-size: 400% 400%; 
      -webkit-background-clip: text; 
      background-clip: text;
      color: transparent; 
      animation: rainbowMove 5s infinite linear; 
    } 
    @keyframes rainbowMove { 
      0% { background-position: 0% 50%; } 
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .channel {
      padding: 8px 12px;
      margin-bottom: 6px;
      cursor: pointer;
      border-radius: 4px;
      position: relative;
      user-select: none;
    }
    .channel.active { background: #e0e0e0; }
    .channel .unread-dot {
      position: absolute;
      top: 10px; right: 10px;
      width: 8px; height: 8px;
      background: red;
      border-radius: 50%;
      display: none;
    }
    #settingsToggle {
      margin-top: auto;
      padding: 8px 12px;
      cursor: pointer;
      border-top: 1px solid #ccc;
      text-align: center;
      user-select: none;
    }

    /* MAIN AREA */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
    }
    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    #chatBox {
      flex: 1;
      border: 1px solid #ccc;
      background: #ffffff;
      padding: 10px;
      overflow-y: auto;
      white-space: pre-wrap;
      margin-bottom: 10px;
    }
  /* Text-like chat appearance */
  #chatBox { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', monospace; font-size: 13px; color: #111; }
  /* Message layout: avatar left, content right */
  .msg { display: flex; gap: 10px; align-items: flex-start; margin: 0; padding: 6px 0; border-bottom: 1px solid #eee; }
  .msg .avatar { width: 40px; height: 40px; border-radius: 6px; object-fit: cover; flex: 0 0 40px; }
  .msg .content { flex: 1; }
  .msg.system { display: block; font-style: italic; color: #666; background: #fafafa; padding: 6px; border-bottom: 1px dashed #eee; }

    #controls {
      display: flex;
      margin-bottom: 10px;
    }
    input#message {
      flex: 1;
      padding: 8px;
      font-size: 1em;
      color: var(--text-color);
      border: 1px solid #ccc;
    }
    button {
      margin-left: 5px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 1em;
    }
    .emoji, .mojicon {
      font-size: 24px;
      cursor: pointer;
      margin: 5px;
      display: inline-block;
    }
    #emojiBoard, #mojiconBoard {
      display: none;
      margin-bottom: 10px;
    }

    /* SETTINGS MODAL */
    #settingsModal {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 1px solid #ccc;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: none;
      z-index: 1000;
      width: 300px;
      box-sizing: border-box;
    }
    #settingsModal h3 { margin-top: 0; }
    #settingsModal label {
      display: block;
      margin: 10px 0;
      font-size: 0.9em;
      cursor: pointer;
    }
    #settingsModal input[type="color"],
    #settingsModal input[type="range"],
    #settingsModal input[type="checkbox"] {
      margin-left: 8px;
      vertical-align: middle;
    }
    #settingsModal .range-value {
      margin-left: 8px;
      font-weight: bold;
    }
    #settingsModal button {
      margin-left: 5px;
      padding: 5px 10px;
      cursor: pointer;
    }

    /* WELCOME POPUP */
    #welcomeModal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    #welcomeModal .content {
      background: white;
      border-radius: 8px;
      padding: 20px;
      max-width: 360px;
      text-align: center;
      position: relative;
      box-shadow: 0 2px 12px rgba(0,0,0,0.3);
    }
    #welcomeModal .content img {
      width: 80px; height: 80px;
      margin-bottom: 15px;
    }
    #welcomeModal .content h3 {
      margin: 0 0 10px;
      font-size: 1.2em;
    }
    #welcomeModal .content p {
      font-size: 0.95em;
      margin-bottom: 20px;
    }
    #welcomeModal .close-btn {
      position: absolute;
      top: 8px; right: 8px;
      background: none;
      border: none;
      font-size: 1.2em;
      cursor: pointer;
    }

    /* ADMIN CONTROLS */
    #adminControls {
      margin-top: 10px;
      display: none;
    }
    #adminControls button {
      margin-right: 5px;
    }

    /* THREADS SIDEBAR (right) */
    #threadsSidebar {
      position: fixed;
      top: 0;
      right: 0;
      height: 100vh;
      width: 320px;
      background: #f9f9f9;
      border-left: 1px solid #ddd;
      box-shadow: -2px 0 6px rgba(0,0,0,0.04);
      padding: 10px;
      box-sizing: border-box;
      transform: translateX(0);
      transition: transform 0.25s ease;
      z-index: 1500;
      right: 0;
    }
    /* collapsed: move completely off-screen */
    #threadsSidebar.collapsed { transform: translateX(100%); pointer-events: none; }
    #threadsToggle {
      position: absolute;
      left: -40px; /* tuck toggle closer to the right edge when collapsed */
      top: 12px;
      width: 40px;
      background: #007bff;
      color: #fff;
      border-radius: 6px 0 0 6px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      z-index:1600;
    }
    #threadsList { overflow-y: auto; max-height: calc(100vh - 80px); padding-top: 40px; }
    .thread-item { padding: 8px 10px; border-bottom: 1px solid #eee; cursor: pointer; }
    .thread-item:hover { background: #fff; }
    .thread-title { font-weight: bold; font-size: 13px; }
    .thread-meta { font-size: 12px; color: #666; }
    /* USERS SIDEBAR */
    #usersSidebar {
      position: fixed;
      top: 0;
      right: 320px; /* sit left of threads by default */
      height: 100vh;
      width: 260px;
      background: #f9f9f9;
      border-left: 1px solid #ddd;
      box-shadow: -2px 0 6px rgba(0,0,0,0.04);
      padding: 10px;
      box-sizing: border-box;
      transform: translateX(0);
      transition: transform 0.25s ease;
      z-index: 1500;
    }
    /* collapsed: move completely off-screen */
    #usersSidebar.collapsed { transform: translateX(110%); pointer-events: none; }
    #usersToggle {
      position: absolute;
      left: -40px; /* tuck toggle closer to the right edge when collapsed */
      top: 12px;
      width: 40px;
      background: #28a745;
      color: #fff;
      border-radius: 6px 0 0 6px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      z-index:1600;
    }
    #usersList { overflow-y: auto; max-height: calc(100vh - 120px); padding-top: 40px; }
    .user-item { padding: 8px 6px; border-bottom: 1px solid #eee; display:flex; align-items:center; gap:8px; }
    .status-dot { width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px; }
  </style>
</head>
<body>

  <!-- WELCOME POPUP -->
  <div id="welcomeModal">
    <div class="content">
      <button class="close-btn" id="welcomeClose">&times;</button>
      <img src="assets/gogologo.png" alt="Logo">
      <h3>Proudly GoGuardian Free</h3>
      <p>Your one-stop chat for everything. Have fun, be kind, and chat away!<br>We respect your privacy and and safety.<br>Questions? DM Me! @GOD HIMSELF</p>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div id="sidebar">
    <!-- Channels injected here -->
    <div id="settingsToggle">⚙️ Settings</div>
  </div>

  <!-- MAIN AREA -->
    <div id="main" style="position:relative;">
    <div id="header">
      <h2>Welcome, <span id="username"></span></h2>
      <span style="display:flex;gap:8px;align-items:center;">
        <button id="threadsOpenBtn">Threads</button>
        <button id="usersOpenBtn">Users</button>
        <button id="statsBtn">Stats</button>
      </span>
      <span id="adminActions" style="display:none;">
        <button id="showBannedBtn">Show Banned</button>
        <button id="helpBtn">Help</button>
      </span>
    </div>

    <!-- THREADS UI -->
    <div id="threadsPanel" style="margin-bottom:20px; background:#f9f9f9; border-radius:8px; padding:10px;">
      <h3>Threads</h3>
      <div id="threadList"></div>
      <form id="newThreadForm" style="margin-top:10px;">
        <input type="text" id="threadTitle" placeholder="Thread title" required style="width:40%;">
        <input type="text" id="threadText" placeholder="First message" required style="width:40%;">
        <button type="submit">Create Thread</button>
      </form>
    </div>

    <div id="threadView" style="display:none; background:#fff; border-radius:8px; box-shadow:0 2px 8px #0001; padding:10px; margin-bottom:20px;"></div>

    <div id="chatBox"></div>

    <div id="controls">
      <input type="text" id="message" placeholder="Type a message…" />
      <button id="sendBtn">Send</button>
      <button id="emojiBtn">😀</button>
      <button id="mojiconBtn">(◐ω◑)</button>
      <button id="customEmojiBtn">🆕</button>
    </div>
    <!-- Admin Emoji Board (hidden by default) -->
    <div id="adminEmojiBoard" style="display:none; position: fixed; top: 100px; right: 40px; width: 300px; background: #fff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); padding: 20px; z-index:1000;">
      <button id="adminEmojiX" style="position:absolute;top:8px;right:8px;background:none;border:none;font-size:1.2em;cursor:pointer;">&times;</button>
      <h2 style="margin-top:0;">Add New Emojis</h2>
      <ul id="admin-emoji-list" style="list-style: none; padding: 0;">
        <li>😀</li>
        <li>🔥</li>
        <li>💯</li>
        <li>Placeholder Emoji</li>
      </ul>
      <textarea id="admin-emoji-edit" style="width:100%;height:80px;margin-top:10px;" placeholder="Add emojis here, one per line..."></textarea>
      <button id="saveAdminEmoji" style="margin-top:10px;width:100%;background:#007bff;color:#fff;border:none;padding:8px;border-radius:4px;cursor:pointer;">Save Emojis</button>
      <button id="closeAdminEmoji" style="margin-top:10px;width:100%;background:#ccc;color:#000;border:none;padding:8px;border-radius:4px;cursor:pointer;">Close</button>
    </div>

    <div id="emojiBoard"></div>
    <div id="mojiconBoard"></div>
    <div id="customEmojiBoard" style="display:none; margin-bottom:10px;"></div>
    <!-- Admin custom emoji editor -->
    <div id="customEmojiEditor" style="display:none; position: fixed; top: 120px; right: 40px; width: 300px; background: #fff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); padding: 20px; z-index:1000;">
      <button id="customEmojiEditorX" style="position:absolute;top:8px;right:8px;background:none;border:none;font-size:1.2em;cursor:pointer;">&times;</button>
      <h2 style="margin-top:0;">Edit Custom Emojis</h2>
      <ul id="adminCommands" style="list-style: none; padding: 0;">
        <li>😺</li>
        <li>🦄</li>
        <li>🍕</li>
        <li>Placeholder Emoji</li>
      </ul>
      <textarea id="custom-emoji-edit" style="width:100%;height:80px;margin-top:10px;" placeholder="Add custom emojis here, one per line..."></textarea>
      <button id="saveCustomEmoji" style="margin-top:10px;width:100%;background:#007bff;color:#fff;border:none;padding:8px;border-radius:4px;cursor:pointer;">Save Custom Emojis</button>
      <button id="closeCustomEmoji" style="margin-top:10px;width:100%;background:#ccc;color:#000;border:none;padding:8px;border-radius:4px;cursor:pointer;">Close</button>
    </div>

    <div id="adminControls">
      <button id="clearBtn">Clear</button>
      <button id="pauseBtn">Pause</button>
      <button id="unpauseBtn">Unpause</button>
      <button id="offBtn">Off</button>
      <button id="onBtn">On</button>
      <button id="statsBtn">Stats</button>
    </div>

  <!-- Threads sidebar (right) -->
  <div id="threadsSidebar" class="collapsed">
    <div id="threadsToggle">Threads</div>
    <h3 style="margin:6px 0 6px 0;">Threads</h3>
    <div id="threadsList">Loading…</div>
  </div>

  <!-- Users sidebar (right) -->
  <div id="usersSidebar" class="collapsed">
    <div id="usersToggle">Users</div>
    <h3 style="margin:6px 0 6px 0;">Online Users</h3>
    <div id="usersList">Loading…</div>
    <div style="position:absolute;bottom:12px;left:12px;right:12px;">
      <button id="allUsersLink" style="width:100%;">All Users</button>
    </div>
  </div>

  <!-- Roadmap UI removed for public chat -->

  <!-- SETTINGS POPUP -->
  <div id="settingsModal">
    <h3>Customize Chat</h3>

    <label>
      <input type="checkbox" id="optSound" />
      Play sound on new messages
    </label>
    <label>
      <input type="checkbox" id="optTimestamp" />
      Show timestamps
    </label>

    <label>
      Sidebar Background:
      <input type="color" id="optSidebarBg" value="#f5f5f5">
    </label>
    <label>
      Main Background:
      <input type="color" id="optMainBg" value="#ffffff">
    </label>
    <label>
      Chat Background:
      <input type="color" id="optChatBg" value="#fafafa">
    </label>
    <label>
      Text Color:
      <input type="color" id="optTextColor" value="#000000">
    </label>
    <label>
      Font Size:
      <input type="range" id="optFontSize" min="12" max="24" value="14">
      <span class="range-value" id="optFontSizeVal">14px</span>
    </label>

    <div style="text-align:right; margin-top:15px;">
      <button id="applyBtn">Apply</button>
      <button id="closeBtn">Close</button>
    </div>
  </div>

  <!-- Notification Sound -->
  <audio id="notifAudio" src="assets/notify.mp3" preload="auto"></audio>

  <script>
  // Roadmap edit/save functionality removed for public chat

    (async function(){
    const API     = 'https://chat-backend-pdzh.onrender.com';
    const user    = localStorage.getItem('chatUser');
    const isAdmin = localStorage.getItem('isAdmin') === 'true';
    if (!user) return location.href = 'index.html';

    // Map of username -> profilePic filename (populated once on load)
    let profileMap = {};
    try {
      const users = await fetch(`${API}/users`).then(r=>r.json());
      if (Array.isArray(users)) {
        users.forEach(u => {
          if (u.username) profileMap[u.username] = u.profilePic || u.avatar || u.img || u.picture || '';
        });
      }
    } catch (err) {
      console.warn('Could not load users for avatars', err);
    }

    // THREADS/REPLIES UI LOGIC
    // Admin-only actions
    const adminActions = document.getElementById('adminActions');
    if (isAdmin) adminActions.style.display = '';
    document.getElementById('showBannedBtn').onclick = async () => {
      const res = await fetch(`${API}/showbanned?admin=${user}`);
      if (res.ok) alert('Banned: ' + (await res.json()).join(', '));
      else alert('Forbidden');
    };
    // Help now goes to help.html (static page)
    document.getElementById('helpBtn').onclick = () => location.href = 'help.html';

    // THREADS UI
    const threadListDiv = document.getElementById('threadList');
    const threadViewDiv = document.getElementById('threadView');
    const newThreadForm = document.getElementById('newThreadForm');

    async function loadThreads() {
      const res = await fetch(`${API}/threads`);
      const threads = await res.json();
      threadListDiv.innerHTML = '';
      threads.forEach(t => {
        const btn = document.createElement('button');
        btn.textContent = `${t.title} (${t.messageCount})`;
        btn.onclick = () => showThread(t.id, t.title);
        threadListDiv.appendChild(btn);
      });
    }

    async function showThread(threadId, threadTitle) {
      const res = await fetch(`${API}/threads/${threadId}`);
      const messages = await res.json();
      threadViewDiv.style.display = 'block';
      threadViewDiv.innerHTML = `<h4>${threadTitle}</h4>`;
      // Render messages and replies (flat, with parentId)
      messages.forEach(msg => {
        const replyBtn = `<button data-msgid="${msg.id}" class="replyBtn">Reply</button>`;
        threadViewDiv.innerHTML += `<div style="margin-bottom:8px; border-bottom:1px solid #eee; padding-bottom:4px;"><strong>${msg.user}</strong>: ${msg.text} ${replyBtn}</div>`;
      });
      // Reply form
      threadViewDiv.innerHTML += `<form id="replyForm" style="margin-top:10px;"><input type="text" id="replyText" placeholder="Reply..." required style="width:70%;"><input type="hidden" id="replyParentId"><button type="submit">Send Reply</button></form><button id="closeThreadView" style="margin-top:10px;">Close</button>`;

      // Reply button logic
      threadViewDiv.querySelectorAll('.replyBtn').forEach(btn => {
        btn.onclick = () => {
          document.getElementById('replyParentId').value = btn.getAttribute('data-msgid');
          document.getElementById('replyText').focus();
        };
      });
      document.getElementById('closeThreadView').onclick = () => {
        threadViewDiv.style.display = 'none';
      };
      document.getElementById('replyForm').onsubmit = async (e) => {
        e.preventDefault();
        const text = document.getElementById('replyText').value;
        const parentId = document.getElementById('replyParentId').value || null;
        await fetch(`${API}/threads/${threadId}/reply`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user, text, parentId })
        });
        showThread(threadId, threadTitle);
      };
    }

    newThreadForm.onsubmit = async (e) => {
      e.preventDefault();
      const title = document.getElementById('threadTitle').value;
      const text = document.getElementById('threadText').value;
      await fetch(`${API}/threads`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, creator: user, text })
      });
      newThreadForm.reset();
      loadThreads();
    };

    loadThreads();
    // ...existing code...

    // ELEMENTS
    const sidebar    = document.getElementById('sidebar');
    const toggle     = document.getElementById('settingsToggle');
    const modal      = document.getElementById('settingsModal');
    const applyBtn   = document.getElementById('applyBtn');
    const closeBtn   = document.getElementById('closeBtn');
    const notifAudio = document.getElementById('notifAudio');

    const optSound     = document.getElementById('optSound');
    const optTimestamp = document.getElementById('optTimestamp');
    const optSidebarBg = document.getElementById('optSidebarBg');
    const optMainBg    = document.getElementById('optMainBg');
    const optChatBg    = document.getElementById('optChatBg');
    const optTextColor = document.getElementById('optTextColor');
    const optFontSize  = document.getElementById('optFontSize');
    const sizeVal      = document.getElementById('optFontSizeVal');
    document.getElementById('username').innerText = user;
    if (isAdmin) document.getElementById('adminControls').style.display = 'block';
  // header buttons wiring (threads/users toggles are added in DOM)
  const threadsOpenBtn = document.getElementById('threadsOpenBtn');
  const usersOpenBtn   = document.getElementById('usersOpenBtn');
  threadsOpenBtn && (threadsOpenBtn.onclick = () => document.getElementById('threadsSidebar').classList.toggle('collapsed'));
  usersOpenBtn && (usersOpenBtn.onclick = () => document.getElementById('usersSidebar').classList.toggle('collapsed'));

    // WELCOME POPUP
    welcomeClose.onclick = () => welcomeModal.style.display = 'none';

    // SETTINGS: load & save
    function loadSettings(){
      const vars = getComputedStyle(document.documentElement);
      const sBg = localStorage.getItem('optSidebarBg')  || vars.getPropertyValue('--sidebar-bg').trim();
      const mBg = localStorage.getItem('optMainBg')     || vars.getPropertyValue('--main-bg').trim();
      const cBg = localStorage.getItem('optChatBg')     || vars.getPropertyValue('--chat-bg').trim();
      const tCol= localStorage.getItem('optTextColor')  || vars.getPropertyValue('--text-color').trim();
      const fSz = localStorage.getItem('optFontSize')   || vars.getPropertyValue('--font-size').trim();
      const snd = localStorage.getItem('optSound') === 'true';
      const ts  = localStorage.getItem('optTimestamp') === 'true';

      optSidebarBg.value = sBg;   document.documentElement.style.setProperty('--sidebar-bg', sBg);
      optMainBg.value    = mBg;   document.documentElement.style.setProperty('--main-bg',    mBg);
      optChatBg.value    = cBg;   document.documentElement.style.setProperty('--chat-bg',    cBg);
      optTextColor.value = tCol;  document.documentElement.style.setProperty('--text-color', tCol);
      optFontSize.value  = parseInt(fSz);
      document.documentElement.style.setProperty('--font-size',  fSz);

      optSound.checked     = snd;
      optTimestamp.checked = ts;
    }

    function saveSettings(){
      localStorage.setItem('optSidebarBg',  optSidebarBg.value);
      localStorage.setItem('optMainBg',     optMainBg.value);
      localStorage.setItem('optChatBg',     optChatBg.value);
      localStorage.setItem('optTextColor',  optTextColor.value);
      localStorage.setItem('optFontSize',   optFontSize.value + 'px');
      localStorage.setItem('optSound',      optSound.checked);
      localStorage.setItem('optTimestamp',  optTimestamp.checked);
      loadSettings();
    }

    toggle.onclick   = () => modal.style.display = 'block';
    closeBtn.onclick = () => modal.style.display = 'none';
    applyBtn.onclick = saveSettings;
    optFontSize.oninput = () => sizeVal.innerText = optFontSize.value + 'px';

    loadSettings();

    // CHANNEL LOGIC
    let channels = [], current = 'public';
    const lastRead = JSON.parse(localStorage.getItem('lastRead') || '{}');

    async function loadChannels(){
      if (user === 'GOD HIMSELF') {
        const all = await fetch(`${API}/users`).then(r=>r.json());
        channels = ['public', ...all.map(u=>u.username).filter(n=>n!=='GOD HIMSELF')];
      } else {
        channels = ['public','GOD HIMSELF'];
      }
      renderChannels();
    }

    function renderChannels(){
      sidebar.querySelectorAll('.channel').forEach(e=>e.remove());
      channels.forEach(ch => {
        const el = document.createElement('div');
        el.className = 'channel';
        el.dataset.ch = ch;
        el.innerText  = ch==='public'?'Public Chat':ch;
        if (ch===current) el.classList.add('active');

        const dot = document.createElement('span');
        dot.className = 'unread-dot';
        el.appendChild(dot);

        el.onclick = () => {
          current = ch;
          document.querySelectorAll('.channel').forEach(c=>c.classList.remove('active'));
          el.classList.add('active');
          dot.style.display = 'none';
          lastRead[ch] = Date.now();
          localStorage.setItem('lastRead', JSON.stringify(lastRead));
          loadChat();
        };

        sidebar.insertBefore(el, toggle);
      });
    }

    // EMOJI / MOJICON
    document.getElementById('emojiBtn').onclick   = () => toggleBoard('emojiBoard','emoji');
    document.getElementById('mojiconBtn').onclick = () => toggleBoard('mojiconBoard','mojicon');
    document.getElementById('customEmojiBtn').onclick = () => toggleBoard('customEmojiBoard','custom');

    // Custom Emoji Board logic (same format)
    function toggleBoard(id, cls) {
      const b = document.getElementById(id);
      b.style.display = b.style.display==='block'?'none':'block';
      if (!b.hasChildNodes()) {
        let list;
        if (cls==='emoji') {
          list = ['😀','😂','😎','😍','😢','😡','👍','👎','🔥','💯','🎉','🤖','🧠','🚀','❤️','🥚','☝️','🤓','🧏','🤫','👋'];
        } else if (cls==='mojicon') {
          list = [':D','(づ ◕‿◕ )づ','( •_•)>⌐■-■','(•‿•)',':)',':(',':`(',';)', 'XD',
             '(◐ω◑)','（ΦωΦ）','(●´⌓`●)','(ᗒᗣᗕ)՞','(o・┏ω┓・o)','¯\\_(ツ)_/¯'];
        } else if (cls==='custom') {
          const adminCommands = document.getElementById('admin-commands-list');
          if (adminCommands && adminCommands.children.length > 0) {
            list = Array.from(adminCommands.children).map(li => li.innerText);
          } else {
            list = ['/ban','/unban','/pause','/unpause','/clear','/off','/on','/warn [user] [reason]'];
          }
        }
        list.forEach(sym => {
          const s = document.createElement('span');
          s.className = cls;
          s.innerText = sym;
          s.onclick = () => {
            const inp = document.getElementById('message');
            inp.value += sym;
            inp.focus();
          };
          b.appendChild(s);
        });
      }
    }

    // Admin custom emoji editor logic
    const customEmojiEditor = document.getElementById('customEmojiEditor');
    const customEmojiBtn = document.getElementById('customEmojiBtn');
    const adminCommands = document.getElementById('adminCommands');
    const customEmojiEdit = document.getElementById('custom-emoji-edit');
    const saveCustomEmojiBtn = document.getElementById('saveCustomEmoji');
    const closeCustomEmojiBtn = document.getElementById('closeCustomEmoji');
    const xCustomEmojiBtn = document.getElementById('customEmojiEditorX');
    // Only show editor for admins
    if (localStorage.getItem('isAdmin') === 'true') {
      customEmojiBtn.style.display = '';
      customEmojiBtn.oncontextmenu = function(e) {
        e.preventDefault();
        customEmojiEditor.style.display = 'block';
        // Load current custom emojis into textarea
        const items = Array.from(customEmojiList.querySelectorAll('li')).map(li => li.innerText);
        customEmojiEdit.value = items.join('\n');
      };
    }
    if (closeCustomEmojiBtn) closeCustomEmojiBtn.onclick = () => customEmojiEditor.style.display = 'none';
    if (xCustomEmojiBtn) xCustomEmojiBtn.onclick = () => customEmojiEditor.style.display = 'none';
    if (saveCustomEmojiBtn) {
      saveCustomEmojiBtn.onclick = function() {
        const lines = customEmojiEdit.value.split('\n').filter(l => l.trim());
        customEmojiList.innerHTML = '';
        lines.forEach(line => {
          customEmojiList.innerHTML += `<li>${line}</li>`;
        });
        customEmojiEditor.style.display = 'none';
      };
    }
    // Admin Emoji Board logic
    const adminEmojiBtn = document.getElementById('adminEmojiBtn');
    const adminEmojiBoard = document.getElementById('adminEmojiBoard');
    const saveAdminEmojiBtn = document.getElementById('saveAdminEmoji');
    const closeAdminEmojiBtn = document.getElementById('closeAdminEmoji');
    const editAdminEmojiArea = document.getElementById('admin-emoji-edit');
    const adminEmojiList = document.getElementById('admin-emoji-list');
    const xEmojiBtn = document.getElementById('adminEmojiX');
    if (isAdmin && adminEmojiBtn) {
      adminEmojiBtn.style.display = '';
      adminEmojiBtn.onclick = function() {
        adminEmojiBoard.style.display = 'block';
        // Load current emojis into textarea
        const items = Array.from(adminEmojiList.querySelectorAll('li')).map(li => li.innerText);
        editAdminEmojiArea.value = items.join('\n');
      };
    }
    if (closeAdminEmojiBtn) closeAdminEmojiBtn.onclick = () => adminEmojiBoard.style.display = 'none';
    if (xEmojiBtn) xEmojiBtn.onclick = () => adminEmojiBoard.style.display = 'none';
    if (saveAdminEmojiBtn) {
      saveAdminEmojiBtn.onclick = function() {
        const lines = editAdminEmojiArea.value.split('\n').filter(l => l.trim());
        adminEmojiList.innerHTML = '';
        lines.forEach(line => {
          adminEmojiList.innerHTML += `<li>${line}</li>`;
        });
        adminEmojiBoard.style.display = 'none';
      };
    }

    function toggleBoard(id, cls) {
      const b = document.getElementById(id);
      b.style.display = b.style.display==='block'?'none':'block';
      if (!b.hasChildNodes()) {
        const list = cls==='emoji'
          ? ['😀','😂','😎','😍','😢','😡','👍','👎','🔥','💯','🎉','🤖','🧠','🚀','❤️','🥚','☝️','🤓','🧏','🤫','👋']
          : [':D','(づ ◕‿◕ )づ','( •_•)>⌐■-■','(•‿•)',':)',':(',':`(',';)', 'XD',
             '(◐ω◑)','（ΦωΦ）','(●´⌓`●)','(ᗒᗣᗕ)՞','(o・┏ω┓・o)','¯\\_(ツ)_/¯'];
        list.forEach(sym => {
          const s = document.createElement('span');
          s.className = cls;
          s.innerText = sym;
          s.onclick = () => {
            const inp = document.getElementById('message');
            inp.value += sym;
            inp.focus();
          };
          b.appendChild(s);
        });
      }
    }

    // LOAD CHAT
    async function loadChat(){
      const box = document.getElementById('chatBox');
      let data;
      if (current==='public') {
        data = await fetch(`${API}/log`).then(r=>r.json());
      } else {
        data = await fetch(`${API}/pm/${encodeURIComponent(user)}/${encodeURIComponent(current)}`)
                 .then(r=>r.json());
      }

      const [ranks,banned,status] = await Promise.all([
        fetch(`${API}/ranks.json`).then(r=>r.json()),
        fetch(`${API}/blacklist.json`).then(r=>r.json()),
        fetch(`${API}/status`).then(r=>r.json())
      ]);

      if (status.off && user!=='GOD HIMSELF') return location.href='off.html';
      if (banned.includes(user))    return location.href='index.html';

      box.innerHTML = '';
      let newest = lastRead[current]||0;

      // Show login/logoff system message if present
      if (current==='public') {
        const sysMsg = localStorage.getItem('systemMessage');
        if (sysMsg) {
          box.innerHTML += `<div class="msg system">${sysMsg}</div>`;
          localStorage.removeItem('systemMessage');
        }
      }

      data.forEach(item=>{
        // system messages
        if (current==='public' && typeof item==='string' && item.startsWith('<<')) {
          box.innerHTML += `<div class="msg system">${item}</div>`;
          return;
        }

        let from,msg,ts;
        if (current==='public') {
          [from,msg] = item.split('>>');
          ts = Date.now();
        } else {
          from = item.from;
          msg  = item.message;
          ts   = item.ts;
        }

        const isNew = ts > (lastRead[current]||0);
        if (isNew && from!==user && optSound.checked) {
          notifAudio.play();
        }
        if (isNew && from!==user) {
          const chEl = document.querySelector(`.channel[data-ch="${current}"]`);
          if (chEl) chEl.querySelector('.unread-dot').style.display = 'block';
        }
        if (ts > newest) newest = ts;

        const sender    = from.trim();
        const userRanks = ranks[sender] || [];
        const rankHtml  = userRanks.map(r=>`<span class="rank-${r.replace(/\s+/g,'-')}">${r}</span>`).join(' ');

        // choose avatar from profileMap (populated at init) or fallback
        const avatar = profileMap && profileMap[sender] ? `assets/${profileMap[sender]}` : 'assets/placeholder.png';

        let header = current==='public'
          ? `<strong class="chat-username" data-user="${sender}">${rankHtml} ${sender}</strong>`
          : `<strong class="chat-username" data-user="${sender}">${sender}</strong>`;

        let contentHtml = `${header}: ${msg}`;
        if (optTimestamp.checked) {
          const t = new Date(ts).toLocaleTimeString();
          contentHtml = `[${t}] ${contentHtml}`;
        }

        // system messages should stay full-width
        if (current==='public' && typeof item==='string' && item.startsWith('<<')) {
          box.innerHTML += `<div class="msg system">${item}</div>`;
        } else {
          const messageHtml = `<img class="avatar" src="${avatar}" alt="${sender}">` +
                              `<div class="content">${contentHtml}</div>`;
          box.innerHTML += `<div class="msg">${messageHtml}</div>`;
        }
      });

      lastRead[current] = newest;
      localStorage.setItem('lastRead', JSON.stringify(lastRead));
      box.scrollTop = box.scrollHeight;
    }

    // SEND MESSAGE
    document.getElementById('sendBtn').onclick = () => {
      const inp = document.getElementById('message');
      const txt = inp.value.trim();
      if (!txt) return;

      if (current==='public') {
        if (isAdmin && txt.startsWith('/')) {
          const [cmd,target,...rest] = txt.split(' ');
          const ep = cmd.slice(1);
          const body = ep==='warn'
            ? { user: target, reason: rest.join(' ') }
            : { user: target };
          fetch(`${API}/${ep}`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(body)
          });
        } else {
          fetch(`${API}/send`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ user, message: txt })
          });
        }
      } else {
        fetch(`${API}/pm`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ from: user, to: current, message: txt })
        });
      }

      inp.value = '';
      loadChat();
    };

    // ADMIN CONTROLS
    document.getElementById('clearBtn').onclick   = ()=>{ fetch(`${API}/clear`,   {method:'POST'}); loadChat(); };
    document.getElementById('pauseBtn').onclick   = ()=>{ fetch(`${API}/pause`,   {method:'POST'}); loadChat(); };
    document.getElementById('unpauseBtn').onclick = ()=>{ fetch(`${API}/unpause`, {method:'POST'}); loadChat(); };
    document.getElementById('offBtn').onclick     = ()=>{ fetch(`${API}/off`,     {method:'POST'}); loadChat(); };
    document.getElementById('onBtn').onclick      = ()=>{ fetch(`${API}/on`,      {method:'POST'}); loadChat(); };
    document.getElementById('statsBtn').onclick   = ()=>window.open('stats.html','_blank');

    // INITIALIZE
    await loadChannels();
    await loadChat();
    setInterval(loadChat, 2000);
      // Threads: load and refresh
      async function loadThreads(){
        const el = document.getElementById('threadsList');
        try {
          const data = await fetch(`${API}/threads`).then(r=>r.json());
          if (!Array.isArray(data)) return el.innerText = 'No threads';
          el.innerHTML = '';
          data.forEach(t => {
            const item = document.createElement('div');
            item.className = 'thread-item';
            item.innerHTML = `<div class="thread-title">${t.title}</div><div class="thread-meta">by ${t.creator} · ${t.messageCount} msgs</div>`;
            item.onclick = async () => {
              // open thread view in a modal or new window (simplest: alert for now)
              const msgs = await fetch(`${API}/threads/${encodeURIComponent(t.id)}`).then(r=>r.json());
              const preview = msgs.map(m=>`${m.user}: ${m.text}`).join('\n\n');
              alert(`Thread: ${t.title}\n---\n${preview}`);
            };
            el.appendChild(item);
          });
        } catch (err) {
          console.error('Error loading threads', err);
          el.innerText = 'Error loading threads';
        }
      }
      document.getElementById('threadsToggle').onclick = () => {
        const s = document.getElementById('threadsSidebar');
        s.classList.toggle('collapsed');
      };
      // Users sidebar toggle and population
      document.getElementById('usersToggle').onclick = () => {
        const s = document.getElementById('usersSidebar');
        s.classList.toggle('collapsed');
      };

      async function loadUsersSidebar(){
        const el = document.getElementById('usersList');
        try {
          const data = await fetch(`${API}/users`).then(r=>r.json());
          if (!Array.isArray(data)) return el.innerText = 'No users';
          el.innerHTML = '';
          data.forEach(u => {
            const item = document.createElement('div');
            item.className = 'thread-item';
            const avatar = u.profilePic || u.avatar || u.img || '';
            const img = `<img src="${avatar?('assets/'+avatar):'assets/placeholder.png'}" style="width:28px;height:28px;border-radius:6px;object-fit:cover;margin-right:8px;vertical-align:middle;">`;
            const online = !!u.online;
            const dotColor = online ? '#28a745' : '#cccccc';
            const statusText = online ? 'Online' : 'Offline';
            item.innerHTML = `<div style="display:flex;align-items:center;justify-content:space-between;"><div style="display:flex;align-items:center;">${img}<div><strong>${u.username}</strong><div style=\"font-size:11px;color:#666;\"><span class=\"status-dot\" style=\"background:${dotColor};margin-right:6px;\"></span>${statusText}</div></div></div></div>`;
            // Clicking a user opens a private channel (mirror threads behavior)
            item.onclick = async () => {
              // set current channel to this user and mark channels UI
              current = u.username;
              // mark active in left channels list if present
              document.querySelectorAll('.channel').forEach(c=>c.classList.remove('active'));
              const chEl = document.querySelector(`.channel[data-ch="${u.username}"]`);
              if (chEl) chEl.classList.add('active');
              // collapse users sidebar
              const us = document.getElementById('usersSidebar');
              us.classList.add('collapsed');
              // load private messages with this user
              await loadChat();
            };
            el.appendChild(item);
          });
        } catch (err) {
          console.error('Error loading users', err);
          el.innerText = 'Error loading users';
        }
      }
      document.getElementById('allUsersLink').onclick = () => location.href = 'users.html';
      // initial users load and periodic refresh
      loadUsersSidebar();
      setInterval(loadUsersSidebar, 7000);
      // initial threads load and periodic refresh
      loadThreads();
      setInterval(loadThreads, 5000);

  })();
  </script>
</body>
</html>
