<!DOCTYPE html>
<html>
<head>
  <title>AlexNET</title>
  <style>
    body { font-family: sans-serif; display: flex; gap: 20px; margin: 0; padding: 20px; }
    #main { flex: 1; }
    #sidebar {
      width: 200px;
      border-left: 1px solid #ccc;
      padding-left: 10px;
    }
    #chatBox {
      white-space: pre-wrap;
      border: 1px solid #ccc;
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 10px;
    }
    input#message { width: calc(100% - 220px); padding: 5px; }
    button { padding: 5px 10px; margin-left: 5px; cursor: pointer; }
    .emoji, .mojicon {
      font-size: 20px;
      cursor: pointer;
      margin: 5px;
      display: inline-block;
    }
    .rank-Egg { color: black; font-weight: bold; }
    .rank-Sigmer {
      font-weight: bold;
      background: linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet);
      -webkit-background-clip: text;
      color: transparent;
    }
    .rank-Discorder {
      font-weight: bold;
      background: linear-gradient(to right, blue, darkblue, indigo, #682860, violet);
      -webkit-background-clip: text;
      color: transparent;
    }
    .rank-BEAN {
      font-weight: bold;
      background: linear-gradient(to right, black, #B7410E, brown, orange, yellow);
      -webkit-background-clip: text;
      color: transparent;
    }
    .rank-OG { color: gold; font-weight: bold; }
    .rank-Bloody { color: darkred; font-weight: bold; }
    .rank-ADMIN {
      font-weight: bold;
      background: linear-gradient(270deg, red, orange, yellow, green, blue, indigo, violet);
      background-size: 400% 400%;
      -webkit-background-clip: text;
      color: transparent;
      animation: rainbowMove 5s infinite linear;
    }
    @keyframes rainbowMove {
      0%   { background-position: 0% 50%; }
      100% { background-position: 100% 50%; }
    }
    .userEntry { margin-bottom: 8px; }
    .userEntry button { font-size: 10px; margin-left: 5px; }
  </style>
</head>
<body>
  <div id="main">
    <h2>Welcome, <span id="username"></span></h2>

    <div id="chatBox"></div>

    <div>
      <input type="text" id="message" placeholder="AChat Message">
      <button onclick="sendMessage()">Send</button>
      <button onclick="toggleEmojiBoard()">üòÄ Emoji Board</button>
      <button onclick="toggleMojiconBoard()">(‚óêœâ‚óë) Mojicon Board</button>
    </div>

    <div id="emojiBoard" style="display:none; margin-top:10px;"></div>
    <div id="mojiconBoard" style="display:none; margin-top:10px;"></div>

    <div id="adminControls" style="margin-top:10px; display:none;">
      <button onclick="adminAction('clear')">Clear</button>
      <button onclick="adminAction('pause')">Pause</button>
      <button onclick="adminAction('unpause')">Unpause</button>
      <button onclick="adminAction('off')">Off</button>
      <button onclick="adminAction('on')">On</button>
      <button onclick="openStats()">Stats</button>
    </div>
  </div>

  <div id="sidebar">
    <h3>Users</h3>
    <div id="userList"></div>
  </div>

  <script>
    const backend = 'https://chat-backend-pdzh.onrender.com';
    const user    = localStorage.getItem('chatUser');
    const isAdmin = localStorage.getItem('isAdmin') === 'true';

    // ‚Ä¶ other functions ‚Ä¶

    async function loadChat() {
      // 1) load logs, ranks, bans, status
      const [logRes, ranksRes, banRes, statusRes] = await Promise.all([
        fetch(`${backend}/log`).then(r=>r.json()),
        fetch(`${backend}/ranks.json`).then(r=>r.json()),
        fetch(`${backend}/blacklist.json`).then(r=>r.json()),
        fetch(`${backend}/status`).then(r=>r.json())
      ]);

      // 2) check if warned
      const warnText = await fetch(`${backend}/warn/${encodeURIComponent(user)}`)
                           .then(r => r.text());
      if (warnText) {
        localStorage.setItem('warnMessage', warnText);
        return location.href = 'warn.html';
      }

      // ‚Ä¶ rest of loadChat: handle off, bans, render chat & sidebar ‚Ä¶
    }

    // ‚Ä¶ sendMessage, adminAction, adminCommand ‚Ä¶

    setInterval(loadChat, 2000);
    v
    if (!user) location.href = 'index.html';
    document.getElementById('username').innerText = user;
    if (isAdmin) document.getElementById('adminControls').style.display = 'block';

    function openStats() {
      window.open('stats.html', '_blank');
    }

    function toggleEmojiBoard() {
      const board = document.getElementById('emojiBoard');
      board.style.display = board.style.display === 'none' ? 'block' : 'none';
      if (!board.hasChildNodes()) {
        const emojis = ['üòÄ','üòÇ','üòé','üòç','üò¢','üò°','üëç','üëé','üî•','üíØ','üéâ','ü§ñ','üß†','üöÄ','‚ù§Ô∏è','ü•ö','‚òùÔ∏è','ü§ì','üßè','ü§´','üëã'];
        emojis.forEach(e => {
          const span = document.createElement('span');
          span.className = 'emoji';
          span.innerText = e;
          span.onclick = () => {
            const input = document.getElementById('message');
            input.value += e;
            input.focus();
          };
          board.appendChild(span);
        });
      }
    }

    function toggleMojiconBoard() {
      const board = document.getElementById('mojiconBoard');
      board.style.display = board.style.display === 'none' ? 'block' : 'none';
      if (!board.hasChildNodes()) {
        const mojicon = [
          ':D','(„Å• ‚óï‚Äø‚óï )„Å•','( ‚Ä¢_‚Ä¢)>‚åê‚ñ†-‚ñ†','(‚Ä¢‚Äø‚Ä¢)',':)',':(',':`(',';)', 'XD',
          '(‚óêœâ‚óë)','ÔºàŒ¶œâŒ¶Ôºâ','(‚óè¬¥‚åì`‚óè)','(·óí·ó£·óï)’û','(o„Éª‚îèœâ‚îì„Éªo)','¬Ø\\_(„ÉÑ)_/¬Ø'
        ];
        mojicon.forEach(e => {
          const span = document.createElement('span');
          span.className = 'mojicon';
          span.innerText = e;
          span.onclick = () => {
            const input = document.getElementById('message');
            input.value += e;
            input.focus();
          };
          board.appendChild(span);
        });
      }
    }

    async function loadChat() {
      const [logRes, ranksRes, bannedRes, statusRes] = await Promise.all([
        fetch(`${backend}/log`).then(r => r.json()),
        fetch(`${backend}/ranks.json`).then(r => r.json()),
        fetch(`${backend}/blacklist.json`).then(r => r.json()),
        fetch(`${backend}/status`).then(r => r.json())
      ]);
      const log    = await logRes;
      const ranks  = await ranksRes;
      const banned = await bannedRes;
      const status = await statusRes;

      // OFF mode & bans
      if (status.off && user !== 'GOD HIMSELF') return location.href = 'off.html';
      if (banned.includes(user)) { alert('You are banned.'); return location.href = 'index.html'; }

      const box      = document.getElementById('chatBox');
      const userList = document.getElementById('userList');
      box.innerHTML      = '';
      userList.innerHTML = '';

      const seenUsers = new Set();

      log.forEach(line => {
        const span = document.createElement('span');

        // 1) System messages (<<‚Ä¶>>)
        if (line.startsWith('<<') && line.endsWith('>>')) {
          span.innerText = line;
          span.style.color     = 'gray';
          span.style.fontStyle = 'italic';
        }
        // 2) Normal chat (user>>message)
        else if (line.includes('>>')) {
          const [rawUser, message] = line.split('>>');
          const sender = rawUser.trim();
          seenUsers.add(sender);

          const userRanks = ranks[sender] || [];
          const rankSpan = userRanks
            .map(r => `<span class="rank-${r.replace(/\s+/g,'-')}">${r}</span>`)
            .join(' ');

          span.innerHTML = `${rankSpan}-${sender}>> ${message}`;
        }
        // 3) Fallback
        else {
          span.innerText = line;
        }

        box.appendChild(span);
        box.appendChild(document.createElement('br'));
      });

      // Sidebar: only the real users
      seenUsers.forEach(name => {
        const entry = document.createElement('div');
        entry.className = 'userEntry';

        const userRanks = ranks[name] || [];
        const rankSpan = userRanks
          .map(r => `<span class="rank-${r.replace(/\s+/g,'-')}">${r}</span>`)
          .join(' ');
        entry.innerHTML = `${rankSpan} ${name}`;

        if (isAdmin) {
          const banBtn   = document.createElement('button');
          const unbanBtn = document.createElement('button');
          banBtn.innerText   = 'Ban';
          unbanBtn.innerText = 'Unban';
          banBtn.onclick     = () => adminCommand('ban', name);
          unbanBtn.onclick   = () => adminCommand('unban', name);
          entry.appendChild(banBtn);
          entry.appendChild(unbanBtn);
        }

        userList.appendChild(entry);
      });
    }

    async function sendMessage() {
      const msg = document.getElementById('message').value.trim();
      if (!msg) return;

      if (isAdmin && msg.startsWith('/')) {
        const [cmd, target, ...rest] = msg.split(' ');
        const endpoint = cmd.slice(1);
        const payload = endpoint === 'warn'
          ? { user: target, reason: rest.join(' ') }
          : { user: target };

        await fetch(`${backend}/${endpoint}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } else {
        await fetch(`${backend}/send`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user, message: msg })
        });
      }

      document.getElementById('message').value = '';
      loadChat();
    }

    async function adminAction(action) {
      await fetch(`${backend}/${action}`, { method: 'POST' });
      loadChat();
    }

    async function adminCommand(cmd, target) {
      const payload = cmd === 'warn'
        ? { user: target, reason: prompt(`Reason to warn ${target}?`) || '' }
        : { user: target };
      await fetch(`${backend}/${cmd}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      loadChat();
    }

    // refresh every 2s
    setInterval(loadChat, 2000);
    loadChat();
  </script>
</body>
</html>
