<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AlexNET Chat</title>
  <style>
    /* ─── THEME VARIABLES ─────────────────────────────────────────────────── */
    :root {
      --sidebar-bg: #f5f5f5;
      --main-bg:    #ffffff;
      --chat-bg:    #fafafa;
      --text-color: #000000;
      --font-size:  14px;
    }

    /* ─── RESET & LAYOUT ───────────────────────────────────────────────────── */
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      font-family: sans-serif;
      background: var(--main-bg);
      color: var(--text-color);
      font-size: var(--font-size);
    }

    /* ─── SIDEBAR ───────────────────────────────────────────────────────────── */
    #sidebar {
      width: 200px;
      background: var(--sidebar-bg);
      border-right: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
    }
    .channel {
      padding: 8px 12px;
      margin-bottom: 6px;
      cursor: pointer;
      border-radius: 4px;
      position: relative;
      user-select: none;
    }
    .channel.active { background: #e0e0e0; }
    .channel .unread-dot {
      position: absolute;
      top: 10px; right: 10px;
      width: 8px; height: 8px;
      background: red;
      border-radius: 50%;
      display: none;
    }
    #settingsToggle {
      margin-top: auto;
      padding: 8px 12px;
      cursor: pointer;
      border-top: 1px solid #ccc;
      text-align: center;
      user-select: none;
    }

    /* ─── MAIN CHAT AREA ───────────────────────────────────────────────────── */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
    }
    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    #chatBox {
      flex: 1;
      border: 1px solid #ccc;
      background: var(--chat-bg);
      padding: 10px;
      overflow-y: auto;
      white-space: pre-wrap;
      margin-bottom: 10px;
    }
    .msg { margin: 4px 0; }
    .msg.system { font-style: italic; color: gray; }

    #controls {
      display: flex;
      margin-bottom: 10px;
    }
    input#message {
      flex: 1;
      padding: 8px;
      font-size: 1em;
      color: var(--text-color);
      border: 1px solid #ccc;
    }
    button {
      margin-left: 5px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 1em;
    }
    .emoji, .mojicon {
      font-size: 24px;
      cursor: pointer;
      margin: 5px;
      display: inline-block;
    }
    #emojiBoard, #mojiconBoard {
      display: none;
      margin-bottom: 10px;
    }

    /* ─── SETTINGS MODAL ─────────────────────────────────────────────────── */
    #settingsModal {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 1px solid #ccc;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: none;
      z-index: 1000;
      width: 300px;
      box-sizing: border-box;
    }
    #settingsModal h3 { margin-top: 0; }
    #settingsModal label {
      display: block;
      margin: 10px 0;
      font-size: 0.9em;
      cursor: pointer;
    }
    #settingsModal input[type="color"],
    #settingsModal input[type="range"] {
      margin-left: 8px;
      vertical-align: middle;
    }
    #settingsModal .range-value {
      margin-left: 8px;
      font-weight: bold;
    }
    #settingsModal button {
      margin-left: 5px;
      padding: 5px 10px;
      cursor: pointer;
    }

    /* ─── WELCOME POPUP ───────────────────────────────────────────────────── */
    #welcomeModal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    #welcomeModal .content {
      background: white;
      border-radius: 8px;
      padding: 20px;
      max-width: 360px;
      text-align: center;
      position: relative;
      box-shadow: 0 2px 12px rgba(0,0,0,0.3);
    }
    #welcomeModal .content img {
      width: 80px;
      height: 80px;
      margin-bottom: 15px;
    }
    #welcomeModal .content h3 {
      margin: 0 0 10px;
      font-size: 1.2em;
    }
    #welcomeModal .content p {
      font-size: 0.95em;
      margin-bottom: 20px;
    }
    #welcomeModal .content .close-btn {
      position: absolute;
      top: 8px; right: 8px;
      background: none;
      border: none;
      font-size: 1.2em;
      cursor: pointer;
    }

    /* ─── ADMIN CONTROLS ─────────────────────────────────────────────────── */
    #adminControls {
      margin-top: 10px;
      display: none;
    }
    #adminControls button {
      margin-right: 5px;
    }
  </style>
</head>
<body>

  <!-- WELCOME POPUP -->
  <div id="welcomeModal">
    <div class="content">
      <button class="close-btn" id="welcomeClose">&times;</button>
      <img src="assets/placeholder.png" alt="Logo">
      <h3>Welcome to AlexNET</h3>
      <p>Your one-stop chat for everything. Have fun, be kind, and chat away!</p>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div id="sidebar">
    <!-- Channels injected by JS -->
    <div id="settingsToggle">⚙️ Settings</div>
  </div>

  <!-- MAIN AREA -->
  <div id="main">
    <div id="header">
      <h2>Welcome, <span id="username"></span></h2>
      <button id="allUsersBtn">All Users</button>
    </div>
    <div id="chatBox"></div>
    <div id="controls">
      <input type="text" id="message" placeholder="Type a message…" />
      <button id="sendBtn">Send</button>
      <button id="emojiBtn">😀</button>
      <button id="mojiconBtn">(◐ω◑)</button>
    </div>
    <div id="emojiBoard"></div>
    <div id="mojiconBoard"></div>
    <div id="adminControls">
      <button id="clearBtn">Clear</button>
      <button id="pauseBtn">Pause</button>
      <button id="unpauseBtn">Unpause</button>
      <button id="offBtn">Off</button>
      <button id="onBtn">On</button>
      <button id="statsBtn">Stats</button>
    </div>
  </div>

  <!-- SETTINGS POPUP -->
  <div id="settingsModal">
    <h3>Customize Chat</h3>
    <label>
      Sidebar Background:
      <input type="color" id="optSidebarBg" value="#f5f5f5">
    </label>
    <label>
      Main Background:
      <input type="color" id="optMainBg" value="#ffffff">
    </label>
    <label>
      Chat Background:
      <input type="color" id="optChatBg" value="#fafafa">
    </label>
    <label>
      Text Color:
      <input type="color" id="optTextColor" value="#000000">
    </label>
    <label>
      Font Size:
      <input type="range" id="optFontSize" min="12" max="24" value="14">
      <span class="range-value" id="optFontSizeVal">14px</span>
    </label>
    <div style="text-align:right; margin-top:15px;">
      <button id="applyBtn">Apply</button>
      <button id="closeBtn">Close</button>
    </div>
  </div>

  <!-- Notification Sound -->
  <audio id="notifAudio" src="assets/notify.mp3" preload="auto"></audio>

  <script>
  (function(){
    const API     = 'https://chat-backend-pdzh.onrender.com';
    const user    = localStorage.getItem('chatUser');
    const isAdmin = localStorage.getItem('isAdmin')==='true';
    if(!user) return location.href='index.html';

    // Show user & admin controls
    document.getElementById('username').innerText = user;
    if(isAdmin) document.getElementById('adminControls').style.display='block';
    document.getElementById('allUsersBtn').onclick = ()=> location.href='users.html';

    /* ─── WELCOME POPUP HANDLER ─────────────────────────────────────────── */
    document.getElementById('welcomeClose').onclick = () => {
      document.getElementById('welcomeModal').style.display = 'none';
    };

    /* ─── SETTINGS LOGIC ───────────────────────────────────────────────── */
    const optSidebar = document.getElementById('optSidebarBg');
    const optMain    = document.getElementById('optMainBg');
    const optChat    = document.getElementById('optChatBg');
    const optText    = document.getElementById('optTextColor');
    const optSize    = document.getElementById('optFontSize');
    const sizeVal    = document.getElementById('optFontSizeVal');
    const modal      = document.getElementById('settingsModal');
    const toggle     = document.getElementById('settingsToggle');
    const applyBtn   = document.getElementById('applyBtn');
    const closeBtn   = document.getElementById('closeBtn');

    function loadSettings(){
      const vars = getComputedStyle(document.documentElement);
      const sBg = localStorage.getItem('optSidebarBg')  || vars.getPropertyValue('--sidebar-bg').trim();
      const mBg = localStorage.getItem('optMainBg')     || vars.getPropertyValue('--main-bg').trim();
      const cBg = localStorage.getItem('optChatBg')     || vars.getPropertyValue('--chat-bg').trim();
      const tCol= localStorage.getItem('optTextColor')  || vars.getPropertyValue('--text-color').trim();
      const fSz = localStorage.getItem('optFontSize')   || vars.getPropertyValue('--font-size').trim();

      optSidebar.value = sBg;
      optMain.value    = mBg;
      optChat.value    = cBg;
      optText.value    = tCol;
      optSize.value    = parseInt(fSz);
      sizeVal.innerText= fSz;

      document.documentElement.style.setProperty('--sidebar-bg', sBg);
      document.documentElement.style.setProperty('--main-bg',    mBg);
      document.documentElement.style.setProperty('--chat-bg',    cBg);
      document.documentElement.style.setProperty('--text-color', tCol);
      document.documentElement.style.setProperty('--font-size',  fSz);
    }

    optSize.oninput = ()=> sizeVal.innerText = optSize.value + 'px';
    toggle.onclick  = ()=> modal.style.display = 'block';
    closeBtn.onclick= ()=> modal.style.display = 'none';

    applyBtn.onclick = () => {
      localStorage.setItem('optSidebarBg', optSidebar.value);
      localStorage.setItem('optMainBg',    optMain.value);
      localStorage.setItem('optChatBg',    optChat.value);
      localStorage.setItem('optTextColor', optText.value);
      localStorage.setItem('optFontSize',  optSize.value + 'px');
      loadSettings();
    };

    loadSettings();

    /* ─── CHANNEL LOGIC ──────────────────────────────────────────────────── */
    let channels = [], current = 'public';
    const sidebar = document.getElementById('sidebar');
    const lastRead= JSON.parse(localStorage.getItem('lastRead')||'{}');

    async function loadChannels(){
      if(user==='GOD HIMSELF'){
        const all = await fetch(`${API}/users`).then(r=>r.json());
        channels = ['public', ...all.map(u=>u.username).filter(n=>n!=='GOD HIMSELF')];
      } else {
        channels = ['public','GOD HIMSELF'];
      }
      renderChannels();
    }

    function renderChannels(){
      sidebar.querySelectorAll('.channel').forEach(e=>e.remove());
      channels.forEach(ch => {
        const el = document.createElement('div');
        el.className = 'channel';
        el.innerText = ch==='public'?'Public Chat':ch;
        if(ch===current) el.classList.add('active');

        const dot = document.createElement('span');
        dot.className = 'unread-dot';
        el.appendChild(dot);

        el.onclick = () => {
          current = ch;
          document.querySelectorAll('.channel').forEach(c=>c.classList.remove('active'));
          el.classList.add('active');
          dot.style.display = 'none';
          lastRead[ch] = Date.now();
          localStorage.setItem('lastRead', JSON.stringify(lastRead));
          loadChat();
        };
        sidebar.insertBefore(el, toggle);
      });
    }

    /* ─── EMOJI & MOJICON ───────────────────────────────────────────────── */
    document.getElementById('emojiBtn').onclick   = toggleEmoji;
    document.getElementById('mojiconBtn').onclick = toggleMojicon;

    function toggleEmoji(){
      const b = document.getElementById('emojiBoard');
      b.style.display = b.style.display==='block'?'none':'block';
      if(!b.hasChildNodes()){
        ['😀','😂','😎','😍','😢','😡','👍','👎','🔥','💯','🎉','🤖','🧠','🚀','❤️','🥚','☝️','🤓','🧏','🤫','👋']
        .forEach(e=>{
          const s = document.createElement('span');
          s.className = 'emoji'; s.innerText = e;
          s.onclick = ()=>{const i=document.getElementById('message'); i.value+=e; i.focus();};
          b.appendChild(s);
        });
      }
    }

    function toggleMojicon(){
      const b = document.getElementById('mojiconBoard');
      b.style.display = b.style.display==='block'?'none':'block';
      if(!b.hasChildNodes()){
        [':D','(づ ◕‿◕ )づ','( •_•)>⌐■-■','(•‿•)',':)',':(',':`(',';)', 'XD',
         '(◐ω◑)','（ΦωΦ）','(●´⌓`●)','(ᗒᗣᗕ)՞','(o・┏ω┓・o)','¯\\_(ツ)_/¯']
        .forEach(f=>{
          const s = document.createElement('span');
          s.className = 'mojicon'; s.innerText = f;
          s.onclick=()=>{const i=document.getElementById('message'); i.value+=f; i.focus();};
          b.appendChild(s);
        });
      }
    }

    /* ─── LOAD CHAT ─────────────────────────────────────────────────────── */
    async function loadChat(){
      const box = document.getElementById('chatBox');
      let data;
      if(current==='public'){
        data = await fetch(`${API}/log`).then(r=>r.json());
      } else {
        data = await fetch(`${API}/pm/${encodeURIComponent(user)}/${encodeURIComponent(current)}`)
                   .then(r=>r.json());
      }

      const [ranks,banned,status] = await Promise.all([
        fetch(`${API}/ranks.json`).then(r=>r.json()),
        fetch(`${API}/blacklist.json`).then(r=>r.json()),
        fetch(`${API}/status`).then(r=>r.json())
      ]);

      if(status.off && user!=='GOD HIMSELF') return location.href='off.html';
      if(banned.includes(user)){ alert('Banned'); return location.href='index.html'; }

      box.innerHTML='';
      let newest = lastRead[current]||0;

      data.forEach(item=>{
        if(current==='public' && typeof item==='string' && item.startsWith('<<')){
          box.innerHTML+=`<div class="msg system">${item}</div>`;
          return;
        }
        let from,msg,ts;
        if(current==='public'){
          [from,msg]=item.split('>>');
          ts = Date.now();
        } else {
          from=item.from; msg=item.message; ts=item.ts;
        }

        const isNew = ts>(lastRead[current]||0);
        if(isNew && from!==user && document.getElementById('optSound')?.checked){
          document.getElementById('notifAudio').play();
        }
        if(isNew && from!==user){
          const ch = [...document.querySelectorAll('.channel')]
            .find(c=>c.innerText=== (current==='public'?'Public Chat':current));
          if(ch) ch.querySelector('.unread-dot').style.display='block';
        }
        if(ts>newest) newest=ts;

        let line;
        if(current==='public'){
          const sender=from.trim();
          const uR=ranks[sender]||[];
          const rHtml = uR.map(r=>`<span class="rank-${r.replace(/\s+/g,'-')}">${r}</span>`).join(' ');
          line=`<strong>${rHtml} ${sender}</strong>: ${msg}`;
        } else {
          line=`<strong>${from}</strong>: ${msg}`;
        }
        if(document.getElementById('optTimestamp')?.checked){
          const t=new Date(ts).toLocaleTimeString();
          line=`[${t}] ${line}`;
        }

        box.innerHTML+=`<div class="msg">${line}</div>`;
      });

      lastRead[current]=newest;
      localStorage.setItem('lastRead', JSON.stringify(lastRead));
      box.scrollTop=box.scrollHeight;
    }

    /* ─── SEND MESSAGE ─────────────────────────────────────────────────── */
    document.getElementById('sendBtn').onclick = () => {
      const inp = document.getElementById('message');
      const txt = inp.value.trim();
      if(!txt) return;

      if(current==='public'){
        if(isAdmin && txt.startsWith('/')){
          const [cmd,target,...rest] = txt.split(' ');
          const ep = cmd.slice(1);
          const body = ep==='warn'
            ? { user: target, reason: rest.join(' ') }
            : { user: target };
          fetch(`${API}/${ep}`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(body)
          });
        } else {
          fetch(`${API}/send`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ user, message: txt })
          });
        }
      } else {
        fetch(`${API}/pm`, {
          method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ from: user, to: current, message: txt })
        });
      }

      inp.value='';
      loadChat();
    };

    /* ─── ADMIN CONTROLS ───────────────────────────────────────────────── */
    document.getElementById('clearBtn').onclick   = ()=> { fetch(`${API}/clear`,   {method:'POST'}); loadChat(); };
    document.getElementById('pauseBtn').onclick   = ()=> { fetch(`${API}/pause`,   {method:'POST'}); loadChat(); };
    document.getElementById('unpauseBtn').onclick = ()=> { fetch(`${API}/unpause`, {method:'POST'}); loadChat(); };
    document.getElementById('offBtn').onclick     = ()=> { fetch(`${API}/off`,     {method:'POST'}); loadChat(); };
    document.getElementById('onBtn').onclick      = ()=> { fetch(`${API}/on`,      {method:'POST'}); loadChat(); };
    document.getElementById('statsBtn').onclick   = ()=> window.open('stats.html','_blank');

    /* ─── INITIALIZE ───────────────────────────────────────────────────── */
    loadChannels().then(()=>{
      loadChat();
      setInterval(loadChat, 2000);
    });
  })();
  </script>
</body>
</html>
```
