<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AlexNET Chat</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      height: 100vh;
    }

    /* ─── LEFT BAR (Channels) ───────────────────────────────────────────────── */
    #sidebar {
      width: 200px;
      background: #f5f5f5;
      border-right: 1px solid #ccc;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
    }
    .channel {
      padding: 8px 12px;
      margin-bottom: 6px;
      cursor: pointer;
      border-radius: 4px;
    }
    .channel.active {
      background: #e0e0e0;
    }

    /* ─── MAIN CHAT AREA ───────────────────────────────────────────────────── */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
    }

    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    #chatBox {
      white-space: pre-wrap;
      border: 1px solid #ccc;
      padding: 10px;
      overflow-y: auto;
      flex: 1;
      margin-bottom: 10px;
    }

    #controls {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    input#message {
      flex: 1;
      padding: 5px;
      font-size: 1em;
    }

    button {
      padding: 5px 10px;
      margin-left: 5px;
      cursor: pointer;
    }

    .emoji, .mojicon {
      font-size: 20px;
      cursor: pointer;
      margin: 5px;
      display: inline-block;
    }

    #emojiBoard, #mojiconBoard {
      display: none;
      margin-bottom: 10px;
    }

    /* ─── RANK STYLES ───────────────────────────────────────────────────────── */
    .rank-Egg { color: black; font-weight: bold; }
    .rank-Sigmer {
      font-weight: bold;
      background: linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet);
      -webkit-background-clip: text;
      color: transparent;
    }
    .rank-Discorder {
      font-weight: bold;
      background: linear-gradient(to right, blue, darkblue, indigo, #682860, violet);
      -webkit-background-clip: text;
      color: transparent;
    }
    .rank-BEAN {
      font-weight: bold;
      background: linear-gradient(to right, black, #B7410E, brown, orange, yellow);
      -webkit-background-clip: text;
      color: transparent;
    }
    .rank-OG { color: gold; font-weight: bold; }
    .rank-Bloody { color: darkred; font-weight: bold; }
    .rank-ADMIN {
      font-weight: bold;
      background: linear-gradient(270deg, red, orange, yellow, green, blue, indigo, violet);
      background-size: 400% 400%;
      -webkit-background-clip: text;
      color: transparent;
      animation: rainbowMove 5s infinite linear;
    }
    @keyframes rainbowMove {
      0%   { background-position: 0% 50%; }
      100% { background-position: 100% 50%; }
    }

    /* ─── ADMIN CONTROLS ─────────────────────────────────────────────────────── */
    #adminControls {
      margin-top: 10px;
      display: none;
    }
    #adminControls button {
      margin-right: 5px;
    }
  </style>
</head>
<body>

  <!-- LEFT BAR: Public / Private Channels -->
  <div id="sidebar"></div>

  <!-- MAIN CHAT AREA -->
  <div id="main">
    <div id="header">
      <h2>Welcome, <span id="username"></span></h2>
      <button id="allUsersBtn">All Users</button>
    </div>

    <div id="chatBox"></div>

    <div id="controls">
      <input type="text" id="message" placeholder="AChat Message" />
      <button onclick="sendMessage()">Send</button>
      <button onclick="toggleEmojiBoard()">😀 Emoji Board</button>
      <button onclick="toggleMojiconBoard()">(◐ω◑) Mojicon Board</button>
    </div>

    <div id="emojiBoard"></div>
    <div id="mojiconBoard"></div>

    <div id="adminControls">
      <button onclick="adminAction('clear')">Clear</button>
      <button onclick="adminAction('pause')">Pause</button>
      <button onclick="adminAction('unpause')">Unpause</button>
      <button onclick="adminAction('off')">Off</button>
      <button onclick="adminAction('on')">On</button>
      <button onclick="openStats()">Stats</button>
    </div>
  </div>

  <script>
    const backend = 'https://chat-backend-pdzh.onrender.com';
    const user    = localStorage.getItem('chatUser');
    const isAdmin = localStorage.getItem('isAdmin') === 'true';

    if (!user) {
      location.href = 'index.html';
      throw '';
    }

    // Show username & admin controls
    document.getElementById('username').innerText = user;
    if (isAdmin) {
      document.getElementById('adminControls').style.display = 'block';
    }

    // “All Users” button
    document.getElementById('allUsersBtn').onclick = () => {
      location.href = 'users.html';
    };

    // Chat state
    let channels = [];
    let currentChannel = 'public';

    // Build channels list
    async function loadChannels() {
      if (user === 'GOD HIMSELF') {
        // GOD HIMSELF sees DM channels with every user
        const all = await fetch(`${backend}/users`).then(r => r.json());
        channels = ['public', ...all.map(u => u.username).filter(n => n !== 'GOD HIMSELF')];
      } else {
        // Everyone else: public + DM GOD HIMSELF
        channels = ['public', 'GOD HIMSELF'];
      }
      renderChannels();
    }

    function renderChannels() {
      const sb = document.getElementById('sidebar');
      sb.innerHTML = '';
      channels.forEach(ch => {
        const div = document.createElement('div');
        div.className = 'channel';
        div.innerText = (ch === 'public' ? 'Public Chat' : ch);
        if (ch === currentChannel) div.classList.add('active');
        div.onclick = () => {
          currentChannel = ch;
          document.querySelectorAll('.channel').forEach(c => c.classList.remove('active'));
          div.classList.add('active');
          loadChat();
        };
        sb.appendChild(div);
      });
    }

    // Emoji / Mojicon boards
    function toggleEmojiBoard() {
      const b = document.getElementById('emojiBoard');
      b.style.display = b.style.display === 'block' ? 'none' : 'block';
      if (!b.hasChildNodes()) {
        ['😀','😂','😎','😍','😢','😡','👍','👎','🔥','💯','🎉','🤖','🧠','🚀','❤️','🥚','☝️','🤓','🧏','🤫','👋']
        .forEach(e => {
          const s = document.createElement('span');
          s.className = 'emoji';
          s.innerText = e;
          s.onclick = () => {
            const inp = document.getElementById('message');
            inp.value += e; inp.focus();
          };
          b.appendChild(s);
        });
      }
    }

    function toggleMojiconBoard() {
      const b = document.getElementById('mojiconBoard');
      b.style.display = b.style.display === 'block' ? 'none' : 'block';
      if (!b.hasChildNodes()) {
        [':D','(づ ◕‿◕ )づ','( •_•)>⌐■-■','(•‿•)',':)',':(',':`(',';)', 'XD',
         '(◐ω◑)','（ΦωΦ）','(●´⌓`●)','(ᗒᗣᗕ)՞','(o・┏ω┓・o)','¯\\_(ツ)_/¯']
        .forEach(f => {
          const s = document.createElement('span');
          s.className = 'mojicon';
          s.innerText = f;
          s.onclick = () => {
            const inp = document.getElementById('message');
            inp.value += f; inp.focus();
          };
          b.appendChild(s);
        });
      }
    }

    // Load chat (public or private)
    async function loadChat() {
      const box = document.getElementById('chatBox');
      let data;
      if (currentChannel === 'public') {
        data = await fetch(`${backend}/log`).then(r => r.json());
      } else {
        data = await fetch(`${backend}/pm/${encodeURIComponent(user)}/${encodeURIComponent(currentChannel)}`)
                .then(r => r.json());
      }

      // fetch singletons
      const [ranks, banned, status] = await Promise.all([
        fetch(`${backend}/ranks.json`).then(r => r.json()),
        fetch(`${backend}/blacklist.json`).then(r => r.json()),
        fetch(`${backend}/status`).then(r => r.json())
      ]);

      if (status.off && user !== 'GOD HIMSELF') {
        return location.href = 'off.html';
      }
      if (banned.includes(user)) {
        alert('You are banned.');
        return location.href = 'index.html';
      }

      box.innerHTML = '';
      data.forEach(item => {
        if (currentChannel === 'public') {
          if (item.startsWith('<<') && item.endsWith('>>')) {
            box.innerHTML += `<div class="msg system">${item}</div>`;
          } else {
            const [rawUser, msg] = item.split('>>');
            const sender = rawUser.trim();
            const userRanks = ranks[sender] || [];
            const rankHtml = userRanks
              .map(r => `<span class="rank-${r.replace(/\s+/g,'-')}">${r}</span>`)
              .join(' ');
            box.innerHTML += `<div class="msg">${rankHtml} <strong>${sender}</strong>: ${msg}</div>`;
          }
        } else {
          // private
          box.innerHTML += `<div class="msg"><strong>${item.from}</strong>: ${item.message}</div>`;
        }
      });

      box.scrollTop = box.scrollHeight;
    }

    // Send message
    async function sendMessage() {
      const inp = document.getElementById('message');
      const txt = inp.value.trim();
      if (!txt) return;

      if (currentChannel === 'public') {
        if (isAdmin && txt.startsWith('/')) {
          const [cmd, target, ...rest] = txt.split(' ');
          const ep = cmd.slice(1);
          const body = ep === 'warn'
            ? { user: target, reason: rest.join(' ') }
            : { user: target };
          await fetch(`${backend}/${ep}`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(body)
          });
        } else {
          await fetch(`${backend}/send`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ user, message: txt })
          });
        }
      } else {
        await fetch(`${backend}/pm`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ from: user, to: currentChannel, message: txt })
        });
      }

      inp.value = '';
      loadChat();
    }

    // Admin actions
    async function adminAction(action) {
      await fetch(`${backend}/${action}`, { method: 'POST' });
      loadChat();
    }
    async function adminCommand(cmd, target) {
      const reason = cmd === 'warn'
        ? prompt(`Reason to warn ${target}?`) || ''
        : '';
      const body = cmd === 'warn'
        ? { user: target, reason }
        : { user: target };
      await fetch(`${backend}/${cmd}`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      loadChat();
    }

    function openStats() {
      window.open('stats.html', '_blank');
    }

    // Initialize
    loadChannels().then(() => {
      renderChannels();
      loadChat();
      setInterval(loadChat, 2000);
    });
  </script>
</body>
</html>
