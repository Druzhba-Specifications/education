<!DOCTYPE html>
<html>
<head>
  <title>AlexNET</title>
  <style>
    body { font-family: sans-serif; display: flex; gap: 20px; margin: 0; padding: 20px; }
    #main { flex: 1; }
    #sidebar {
      width: 200px;
      border-left: 1px solid #ccc;
      padding-left: 10px;
    }
    #chatBox {
      white-space: pre-wrap;
      border: 1px solid #ccc;
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 10px;
    }
    input#message { width: calc(100% - 110px); padding: 5px; }
    button { padding: 5px 10px; margin-left: 5px; cursor: pointer; }

    .emoji {
      font-size: 20px;
      cursor: pointer;
      margin: 5px;
      display: inline-block;
    }

    .rank-Sigmer {
      font-weight: bold;
      background: linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet);
      -webkit-background-clip: text;
      color: transparent;
    }
    .rank-OG { color: gold; font-weight: bold; }
    .rank-Bloody { color: darkred; font-weight: bold; }
    .rank-ADMIN {
      font-weight: bold;
      background: linear-gradient(270deg, red, orange, yellow, green, blue, indigo, violet);
      background-size: 400% 400%;
      -webkit-background-clip: text;
      color: transparent;
      animation: rainbowMove 5s infinite linear;
    }
    @keyframes rainbowMove {
      0%   { background-position: 0% 50%; }
      100% { background-position: 100% 50%; }
    }
    .userEntry { margin-bottom: 8px; }
    .userEntry button { font-size: 10px; margin-left: 5px; }
  </style>
</head>
<body>
  <div id="main">
    <h2>Welcome, <span id="username"></span></h2>

    <div id="chatBox"></div>

    <div>
      <input type="text" id="message" placeholder="AChat Message">
      <button onclick="sendMessage()">Send</button>
      <button onclick="toggleEmojiBoard()">ðŸ˜€ Emoji Board</button>
    </div>
    <div id="emojiBoard" style="display:none; margin-top:10px;"></div>

    <div id="adminControls" style="margin-top:10px; display:none;">
      <button onclick="adminAction('clear')">Clear</button>
      <button onclick="adminAction('pause')">Pause</button>
      <button onclick="adminAction('unpause')">Unpause</button>
      <button onclick="adminAction('off')">Off</button>
      <button onclick="adminAction('on')">On</button>
      <button onclick="openStats()">Stats</button>
    </div>
  </div>

  <div id="sidebar">
    <h3>Users</h3>
    <div id="userList"></div>
  </div>

  <script>
    const backend = 'https://chat-backend-pdzh.onrender.com';
    const user    = localStorage.getItem('chatUser');
    const isAdmin = localStorage.getItem('isAdmin') === 'true';

    if (!user) {
      // your login screen is index.html
      location.href = 'index.html';
    }

    document.getElementById('username').innerText = user;
    if (isAdmin) {
      document.getElementById('adminControls').style.display = 'block';
    }

    function openStats() {
      window.open('stats.html', '_blank');
    }

    function toggleEmojiBoard() {
      const board = document.getElementById('emojiBoard');
      board.style.display = board.style.display === 'none' ? 'block' : 'none';
      if (!board.hasChildNodes()) {
        const emojis = ['ðŸ˜€','ðŸ˜‚','ðŸ˜Ž','ðŸ˜','ðŸ˜¢','ðŸ˜¡','ðŸ‘','ðŸ‘Ž','ðŸ”¥','ðŸ’¯','ðŸŽ‰','ðŸ¤–','ðŸ§ ','ðŸš€','â¤ï¸'];
        emojis.forEach(e => {
          const span = document.createElement('span');
          span.className = 'emoji';
          span.innerText = e;
          span.onclick = () => {
            const input = document.getElementById('message');
            input.value += e;
            input.focus();
          };
          board.appendChild(span);
        });
      }
    }

    async function loadChat() {
      const [logRes, ranksRes, bannedRes, statusRes] = await Promise.all([
        fetch(`${backend}/log`),
        fetch(`${backend}/ranks.json`),
        fetch(`${backend}/blacklist.json`),
        fetch(`${backend}/status`)
      ]);
      const log    = await logRes.json();
      const ranks  = await ranksRes.json();
      const banned = await bannedRes.json();
      const status = await statusRes.json();

      // redirect if chat is turned off
      if (status.off && !isAdmin) {
        return location.href = 'off.html';
      }

      // if banned
      if (banned.includes(user)) {
        alert('You are banned.');
        return location.href = 'index.html';
      }

      const box      = document.getElementById('chatBox');
      const userList = document.getElementById('userList');
      box.innerHTML      = '';
      userList.innerHTML = '';

      const seenUsers = new Set();

      log.forEach(line => {
        const span = document.createElement('span');

        if (line.includes('>>')) {
          // normal chat line
          const [rawUser, message] = line.split('>>');
          const sender = rawUser.trim();
          seenUsers.add(sender);

          const userRanks = ranks[sender] || [];
          const rankSpan = userRanks
            .map(r => `<span class="rank-${r.replace(/\s+/g,'-')}">${r}</span>`)
            .join(' ');

          span.innerHTML = `${rankSpan}-${sender}>> ${message}`;
        }
        else if (line.startsWith('<<') && line.endsWith('>>')) {
          // system message (login/logout/pause/unpause)
          span.innerText = line;
          span.style.color     = 'gray';
          span.style.fontStyle = 'italic';
        }
        else {
          // anything else
          span.innerText = line;
        }

        box.appendChild(span);
        box.appendChild(document.createElement('br'));
      });

      // sidebar user list
      seenUsers.forEach(name => {
        const entry = document.createElement('div');
        entry.className = 'userEntry';

        const userRanks = ranks[name] || [];
        const rankSpan = userRanks
          .map(r => `<span class="rank-${r.replace(/\s+/g,'-')}">${r}</span>`)
          .join(' ');

        entry.innerHTML = `${rankSpan} ${name}`;

        if (isAdmin) {
          const banBtn = document.createElement('button');
          banBtn.innerText = 'Ban';
          banBtn.onclick = () => adminCommand('ban', name);

          const unbanBtn = document.createElement('button');
          unbanBtn.innerText = 'Unban';
          unbanBtn.onclick = () => adminCommand('unban', name);

          entry.appendChild(banBtn);
          entry.appendChild(unbanBtn);
        }

        userList.appendChild(entry);
      });
    }

    async function sendMessage() {
      const msg = document.getElementById('message').value.trim();
      if (!msg) return;

      // admin slash-commands
      if (isAdmin && msg.startsWith('/')) {
        const [cmd, arg, ...rest] = msg.split(' ');
        const payload = { user: arg, reason: arg, message: rest.join(' ') };

        if (['ban','unban','warn'].includes(cmd.slice(1))) {
          await fetch(`${backend}/${cmd.slice(1)}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        }
        else if (cmd === '/del') {
          await fetch(`${backend}/del`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ line: parseInt(arg) })
          });
        }
      }
      else {
        // normal message
        await fetch(`${backend}/send`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user, message: msg })
        });
      }

      document.getElementById('message').value = '';
      loadChat();
    }

    async function adminAction(action) {
      await fetch(`${backend}/${action}`, { method: 'POST' });
      loadChat();
    }

    async function adminCommand(type, target) {
      await fetch(`${backend}/${type}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user: target })
      });
      loadChat();
    }

    // refresh every 2s
    setInterval(loadChat, 2000);
    loadChat();
  </script>
</body>
</html>
