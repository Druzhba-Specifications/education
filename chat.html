<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AlexNET Chat</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      height: 100vh;
    }
    /* Sidebar */
    #sidebar {
      width: 60px;
      background: #2f3136;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 10px;
    }
    .chat-icon {
      width: 40px;
      height: 40px;
      margin: 10px 0;
      position: relative;
      cursor: pointer;
    }
    .chat-icon img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
    }
    .unread-dot {
      position: absolute;
      top: 2px;
      right: 2px;
      width: 8px;
      height: 8px;
      background: red;
      border-radius: 50%;
      display: none;
    }
    #settingsBtn {
      margin-top: auto;
      margin-bottom: 20px;
    }
    /* Main chat area */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    #header {
      background: #36393f;
      color: white;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #chatBox {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #e3e5e8;
      white-space: pre-wrap;
    }
    .msg {
      margin: 5px 0;
    }
    .msg.system {
      font-style: italic;
      color: gray;
    }
    .msg .meta {
      font-size: 0.8em;
      color: #555;
    }
    /* Input controls */
    #controls {
      padding: 10px;
      background: #f0f0f0;
      display: flex;
    }
    #message {
      flex: 1;
      padding: 8px;
      font-size: 1em;
    }
    button {
      margin-left: 5px;
      padding: 8px 12px;
      font-size: 1em;
      cursor: pointer;
    }
    /* Settings modal */
    #settingsModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 1px solid #ccc;
      padding: 20px;
      display: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 10;
    }
    #settingsModal label {
      display: block;
      margin: 8px 0;
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div id="sidebar">
    <div class="chat-icon" data-chat="public" title="Public Chat">
      <img src="assets/placeholder.png" alt="Public">
      <span class="unread-dot"></span>
    </div>
    <div class="chat-icon" data-chat="GOD HIMSELF" title="DM: GOD HIMSELF">
      <img src="assets/god.png" alt="GOD HIMSELF">
      <span class="unread-dot"></span>
    </div>
    <div id="settingsBtn" class="chat-icon" title="Settings">
      <img src="assets/placeholder.png" alt="Settings">
    </div>
  </div>

  <!-- Main chat -->
  <div id="main">
    <div id="header">
      <div id="chatTitle">Public Chat</div>
      <div id="userDisplay"></div>
    </div>

    <div id="chatBox"></div>

    <div id="controls">
      <input type="text" id="message" placeholder="Type a messageâ€¦" />
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <!-- Settings modal -->
  <div id="settingsModal">
    <h3>Settings</h3>
    <label>
      <input type="checkbox" id="optSound" />
      Play sound on new messages
    </label>
    <label>
      <input type="checkbox" id="optTimestamp" />
      Show timestamps
    </label>
    <button id="closeSettings">Close</button>
  </div>

  <!-- Notification sound -->
  <audio id="notifAudio" src="assets/notify.mp3" preload="auto"></audio>

  <script>
  (function() {
    const API        = 'https://chat-backend-pdzh.onrender.com';
    const current    = localStorage.getItem('chatUser');
    const isAdmin    = localStorage.getItem('isAdmin') === 'true';
    if (!current) {
      return location.href = 'index.html';
    }

    // Settings state
    const optSoundEl     = document.getElementById('optSound');
    const optTimestampEl = document.getElementById('optTimestamp');
    optSoundEl.checked     = localStorage.getItem('optSound') === 'true';
    optTimestampEl.checked = localStorage.getItem('optTimestamp') === 'true';

    function saveSettings() {
      localStorage.setItem('optSound', optSoundEl.checked);
      localStorage.setItem('optTimestamp', optTimestampEl.checked);
    }

    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').style.display = 'block';
    };
    document.getElementById('closeSettings').onclick = () => {
      saveSettings();
      document.getElementById('settingsModal').style.display = 'none';
    };

    // Chat state
    let currentChat = 'public';
    const lastRead  = JSON.parse(localStorage.getItem('lastRead') || '{}');
    const icons     = document.querySelectorAll('.chat-icon[data-chat]');

    icons.forEach(icon => {
      icon.onclick = () => {
        const chat = icon.getAttribute('data-chat');
        currentChat = chat;
        document.getElementById('chatTitle').innerText = 
          chat === 'public' ? 'Public Chat' : 'DM: ' + chat;
        // clear unread dot
        icon.querySelector('.unread-dot').style.display = 'none';
        lastRead[chat] = Date.now();
        localStorage.setItem('lastRead', JSON.stringify(lastRead));
        loadMessages();
      };
    });

    // Show username
    document.getElementById('userDisplay').innerText = current;

    // Send message
    document.getElementById('sendBtn').onclick = async () => {
      const msg = document.getElementById('message').value.trim();
      if (!msg) return;
      if (currentChat === 'public') {
        await fetch(`${API}/send`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ user: current, message: msg })
        });
      } else {
        await fetch(`${API}/pm`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ from: current, to: currentChat, message: msg })
        });
      }
      document.getElementById('message').value = '';
      loadMessages();
    };

    // Load messages
    async function loadMessages() {
      const box = document.getElementById('chatBox');
      let data;
      if (currentChat === 'public') {
        data = await fetch(`${API}/log`).then(r => r.json());
      } else {
        data = await fetch(`${API}/pm/${encodeURIComponent(current)}/${encodeURIComponent(currentChat)}`)
                  .then(r => r.json());
      }
      box.innerHTML = '';
      let newest = lastRead[currentChat] || 0;

      data.forEach(item => {
        let from, text, ts;
        if (currentChat === 'public') {
          if (item.startsWith('<<') && item.endsWith('>>')) {
            box.innerHTML += `<div class="msg system">${item}</div>`;
            return;
          }
          [from, text] = item.split('>>');
          ts = Date.now();
        } else {
          from = item.from;
          text = item.message;
          ts = item.ts;
        }
        const isNew = ts > (lastRead[currentChat] || 0);
        if (isNew && from !== current) {
          // play sound
          if (optSoundEl.checked) {
            document.getElementById('notifAudio').play();
          }
          // show unread dot
          const icon = document.querySelector(`.chat-icon[data-chat="${currentChat}"]`);
          icon.querySelector('.unread-dot').style.display = 'block';
        }
        if (isNew && ts > newest) {
          newest = ts;
        }

        const meta = document.createElement('span');
        meta.className = 'meta';
        meta.innerText = from + (optTimestampEl.checked 
          ? ` [${new Date(ts).toLocaleTimeString()}]` 
          : '') + ': ';

        const msgDiv = document.createElement('div');
        msgDiv.className = 'msg';
        msgDiv.appendChild(meta);
        msgDiv.appendChild(document.createTextNode(text));
        box.appendChild(msgDiv);
      });

      lastRead[currentChat] = newest;
      localStorage.setItem('lastRead', JSON.stringify(lastRead));
      box.scrollTop = box.scrollHeight;
    }

    // Auto-refresh
    setInterval(loadMessages, 2000);
    loadMessages();
  })();
  </script>
</body>
</html>
