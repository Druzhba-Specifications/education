<!DOCTYPE html>
<html>
<head>
  <title>Login</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin-top: 100px;
    }
    input {
      margin: 5px;
      padding: 8px;
      width: 200px;
    }
    button {
      padding: 8px 16px;
      margin-top: 10px;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script>
</head>
<body>
  <h2>Chat Login</h2>
  <div style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace; display:inline-block; text-align:left;">
    <label>Username<br><input type="text" id="username" placeholder="username"></label><br>
    <label>Password<br><input type="password" id="password" placeholder="password"></label><br>
    <div style="margin-top:8px; display:flex; gap:8px;">
      <button id="loginBtn">Login</button>
      <button id="showRegisterBtn">Create account</button>
    </div>
  </div>

  <div id="registerBox" style="display:none; margin-top:16px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace;">
    <h3 style="margin:4px 0;">Create account</h3>
    <label>Username<br><input type="text" id="regUsername" placeholder="username"></label><br>
    <label>Password<br><input type="password" id="regPassword" placeholder="password"></label><br>
    <button id="registerBtn">Create</button>
    <button id="cancelRegisterBtn">Cancel</button>
    <div id="regMsg" style="color:#a00;margin-top:6px;"></div>
  </div>

  <!-- Roadmap UI (view only) -->
  <div id="roadmap-container" style="position: fixed; top: 50px; right: 40px; width: 300px; background: #fff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); padding: 20px; z-index:999;">
    <h2 style="margin-top:0;">Roadmap</h2>
    <ul id="roadmap-list" style="list-style: none; padding: 0;">
      <li><strong>Add Threads/Replies and Roadmap Table: </strong>Done!</li>
      <li><strong>Private DMs for all, not just GOD HIMSELF for support: </strong>Not Started</li>
      <li><strong>Polls: </strong>Not Started</li>
      <li><strong>Live Typing Feed (ex. GOD HIMSELF is typing...): </strong>Not Started</li>
    </ul>
    <h2 style="font-size:1em;">Any ideas? Message or DM Me! @GOD HIMSELF</h2>
  </div>

  <script>
  const backend = 'https://chat-backend-pdzh.onrender.com';

    // Make login button instant and responsive
    document.getElementById('loginBtn').addEventListener('click', login);
    document.getElementById('username').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') login();
    });
    document.getElementById('password').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') login();
    });

    async function login() {
      const username = document.getElementById('username').value.trim();
      const password = md5(document.getElementById('password').value.trim());

      if (!username || !password) {
        alert('Please enter both username and password.');
        return;
      }

      // Disable button to prevent double clicks
      const btn = document.getElementById('loginBtn');
      btn.disabled = true;
      btn.textContent = 'Logging in...';

      try {
        const res = await fetch(`${backend}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        if (res.ok) {
          const result = await res.json();
          if (result.success) {
            localStorage.setItem('chatUser', username);
            localStorage.setItem('isAdmin', result.isAdmin || false);
            localStorage.setItem('systemMessage', `${username} logged in.`);
            location.href = result.redirect || 'chat.html';
            return;
          }
        }
        // If backend login failed, fall back to localStorage users (for offline/demo)
        const localUsers = JSON.parse(localStorage.getItem('localUsers') || '[]');
        const match = localUsers.find(u => u.username === username && u.password === password);
        if (match) {
          localStorage.setItem('chatUser', username);
          localStorage.setItem('isAdmin', !!match.isAdmin);
          localStorage.setItem('systemMessage', `${username} logged in.`);
          location.href = 'chat.html';
          return;
        }
        alert('âŒ Invalid username or password.');
      } catch (err) {
        alert('Login failed. Please try again.');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Login';
      }
    }

    // Registration flow (tries backend, falls back to localStorage)
    document.getElementById('showRegisterBtn').onclick = () => {
      document.getElementById('registerBox').style.display = 'block';
    };
    document.getElementById('cancelRegisterBtn').onclick = () => {
      document.getElementById('registerBox').style.display = 'none';
    };
    document.getElementById('registerBtn').onclick = async () => {
      const u = document.getElementById('regUsername').value.trim();
      const p = md5(document.getElementById('regPassword').value.trim());
      const msgEl = document.getElementById('regMsg');
      if (!u || !p) { msgEl.innerText = 'Please provide username and password.'; return; }
      msgEl.innerText = '';
      try {
        // Try backend /register then fallback to /users
        let ok = false;
        try {
          const res = await fetch(`${backend}/register`, {
            method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ username: u, password: p })
          });
          if (res.ok) ok = true;
        } catch (e) { /* ignore */ }
        if (!ok) {
          try {
            const res2 = await fetch(`${backend}/users`, {
              method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ username: u, password: p })
            });
            if (res2.ok) ok = true;
          } catch (e) { /* ignore */ }
        }
        if (!ok) {
          // fallback local create
          const localUsers = JSON.parse(localStorage.getItem('localUsers')||'[]');
          if (localUsers.find(x=>x.username===u)) { msgEl.innerText = 'User already exists (offline mode).'; return; }
          localUsers.push({ username: u, password: p, isAdmin: false });
          localStorage.setItem('localUsers', JSON.stringify(localUsers));
        }
        // Auto-login new user
        localStorage.setItem('chatUser', u);
        localStorage.setItem('isAdmin', false);
        localStorage.setItem('systemMessage', `${u} created account and logged in.`);
        location.href = 'chat.html';
      } catch (err) {
        msgEl.innerText = 'Registration failed.';
      }
    };

    // Roadmap edit/save functionality removed for public view
  </script>
</body>
</html>
