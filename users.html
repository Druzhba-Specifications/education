<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>All Users</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .user-list { display: flex; flex-wrap: wrap; gap: 20px; }
    .user-card {
      width: 180px;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      text-align: center;
    }
    .user-card img {
      width: 80px; height: 80px;
      border-radius: 50%;
      object-fit: cover; margin-bottom: 8px;
    }
    .username { font-weight: bold; margin-bottom: 4px; }
    .ranks { font-size: 0.9em; color: #555; margin-bottom: 8px; }
    .online { color: green; font-size: 0.85em; margin-bottom: 8px; }
    .offline { color: gray; font-size: 0.85em; margin-bottom: 8px; }
    .banned { color: red; font-size: 0.85em; margin-bottom: 8px; }
    .admin-btn { margin-top: 6px; padding: 4px 8px; cursor: pointer; }
    #controls { margin-top: 30px; text-align: center; }
    #refresh { padding: 8px 16px; }
  </style>
</head>
<body>
  <h1>All Users</h1>
  <div class="user-list" id="userList">Loading…</div>
  <div id="controls">
    <button id="refresh">Refresh</button>
  </div>

  <script>
    (async function() {
      const API     = 'https://chat-backend-pdzh.onrender.com';
      const current = localStorage.getItem('chatUser');
      const isAdmin = localStorage.getItem('isAdmin') === 'true';

      // If not logged in, kick to index
      if (!current) {
        return location.href = 'index.html';
      }

      // Fetch /users to check your ban status
      let users;
      try {
        users = await fetch(`${API}/users`).then(r => r.json());
      } catch {
        document.getElementById('userList').innerText = 'Error loading users';
        return;
      }
      const me = users.find(u => u.username === current);
      if (me && me.banned && current !== 'GOD HIMSELF') {
        alert('You have been banned.');
        return location.href = 'index.html';
      }

      // Fetch ranks once
      let ranks = {};
      try {
        ranks = await fetch(`${API}/ranks.json`).then(r => r.json());
      } catch {}

      const listEl = document.getElementById('userList');

      async function render() {
        listEl.innerHTML = 'Loading…';
        try {
          users = await fetch(`${API}/users`).then(r => r.json());
        } catch {
          listEl.innerText = 'Error loading users';
          return;
        }
        listEl.innerHTML = '';

        users.forEach(u => {
          const card = document.createElement('div');
          card.className = 'user-card';

          // Avatar
          const img = document.createElement('img');
          img.src = u.profilePic === 'placeholder.png'
            ? 'placeholder.png'
            : `${API}/assets/${u.profilePic}`;
          card.appendChild(img);

          // Name
          const nameDiv = document.createElement('div');
          nameDiv.className = 'username';
          nameDiv.innerText = u.username;
          card.appendChild(nameDiv);

          // Ranks
          const userRanks = ranks[u.username] || [];
          const ranksDiv = document.createElement('div');
          ranksDiv.className = 'ranks';
          ranksDiv.innerText = userRanks.length
            ? `Ranks: ${userRanks.join(', ')}`
            : 'Ranks: none';
          card.appendChild(ranksDiv);

          // Online/Offline
          const statDiv = document.createElement('div');
          statDiv.className = u.online ? 'online' : 'offline';
          statDiv.innerText = u.online ? 'Online' : 'Offline';
          card.appendChild(statDiv);

          // Banned badge
          if (u.banned) {
            const banDiv = document.createElement('div');
            banDiv.className = 'banned';
            banDiv.innerText = 'BANNED';
            card.appendChild(banDiv);
          }

          // Admin Ban/Unban
          if (isAdmin) {
            const btn = document.createElement('button');
            btn.className = 'admin-btn';
            btn.innerText = u.banned ? 'Unban' : 'Ban';
            btn.onclick = async () => {
              await fetch(`${API}/${u.banned ? 'unban' : 'ban'}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user: u.username })
              });
              render();
            };
            card.appendChild(btn);
          }

          listEl.appendChild(card);
        });
      }

      document.getElementById('refresh').onclick = render;
      render();
    })();
  </script>
</body>
</html>
