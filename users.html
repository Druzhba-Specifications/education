<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>All Users</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .user-list { display: flex; flex-wrap: wrap; gap: 12px; }
    .user-card {
      display: flex;
      align-items: center;
      width: 320px;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 8px 10px;
      text-align: left;
      gap: 12px;
      background: #fff;
      box-sizing: border-box;
    }
    .user-card img {
      width: 56px;
      height: 56px;
      border-radius: 8px;
      object-fit: cover;
      flex: 0 0 56px;
      margin: 0;
    }
    .user-info { flex: 1 1 auto; display: flex; flex-direction: column; gap: 4px; }
    .username { font-weight: bold; margin-bottom: 4px; }
    .ranks   { font-size: 0.9em; color: #555; margin-bottom: 8px; }
    .online  { color: green; font-size: 0.85em; margin-bottom: 8px; }
    .offline { color: gray;  font-size: 0.85em; margin-bottom: 8px; }
    .banned  { color: red;   font-size: 0.85em; margin-bottom: 8px; }
    .admin-btn { margin-top: 6px; padding: 4px 8px; cursor: pointer; }
    #controls { margin-top: 30px; text-align: center; }
    #refresh  { padding: 8px 16px; }
  </style>
</head>
<body>
  <h1>All Users</h1>
  <div class="user-list" id="userList">Loading…</div>
  <div id="controls">
    <button id="refresh">Refresh</button>
  </div>

  <script>
    (async function() {
      const API     = 'https://chat-backend-pdzh.onrender.com';
      const current = localStorage.getItem('chatUser');
      const isAdmin = localStorage.getItem('isAdmin') === 'true';

      // Redirect to login if no user
      if (!current) {
        return location.href = 'index.html';
      }

      // 1) Initial fetch to see if you’re banned
      let users;
      try {
        users = await fetch(`${API}/users`).then(r => r.json());
      } catch (err) {
        console.error('Error fetching users:', err);
        document.getElementById('userList').innerText = 'Error loading users';
        return;
      }
      const me = users.find(u => u.username === current);
      if (me && me.banned && current !== 'GOD HIMSELF') {
        alert('You have been banned.');
        return location.href = 'index.html';
      }

      // 2) Fetch ranks once
      let ranks = {};
      try {
        ranks = await fetch(`${API}/ranks.json`).then(r => r.json());
      } catch (err) {
        console.error('Error fetching ranks:', err);
      }

      const listEl = document.getElementById('userList');

      // 3) Render function
      async function render() {
        listEl.innerHTML = 'Loading…';
        try {
          users = await fetch(`${API}/users`).then(r => r.json());
        } catch (err) {
          console.error('Error re-fetching users:', err);
          listEl.innerText = 'Error loading users';
          return;
        }
        listEl.innerHTML = '';

        users.forEach(u => {
          const card = document.createElement('div');
          card.className = 'user-card';

          // Avatar (always load from local assets folder)
          const img = document.createElement('img');
          img.src = `assets/${u.profilePic}`;

          // Info container (to the right of avatar)
          const info = document.createElement('div');
          info.className = 'user-info';

          // Username
          const nameDiv = document.createElement('div');
          nameDiv.className = 'username';
          nameDiv.innerText = u.username;
          info.appendChild(nameDiv);

          // Ranks
          const userRanks = ranks[u.username] || [];
          const ranksDiv = document.createElement('div');
          ranksDiv.className = 'ranks';
          ranksDiv.innerText = userRanks.length
            ? `Ranks: ${userRanks.join(', ')}`
            : 'Ranks: none';
          info.appendChild(ranksDiv);

          // Online / Offline
          const statusDiv = document.createElement('div');
          statusDiv.className = u.online ? 'online' : 'offline';
          statusDiv.innerText = u.online ? 'Online' : 'Offline';
          info.appendChild(statusDiv);

          // Banned badge
          if (u.banned) {
            const banDiv = document.createElement('div');
            banDiv.className = 'banned';
            banDiv.innerText = 'BANNED';
            info.appendChild(banDiv);
          }

          // Admin Ban/Unban (place to the right inside info)
          if (isAdmin) {
            const btn = document.createElement('button');
            btn.className = 'admin-btn';
            btn.innerText = u.banned ? 'Unban' : 'Ban';
            btn.onclick = async () => {
              await fetch(`${API}/${u.banned ? 'unban' : 'ban'}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user: u.username })
              });
              render();
            };
            // place admin button at the end of info
            info.appendChild(btn);
          }

          card.appendChild(img);
          card.appendChild(info);
          listEl.appendChild(card);
        });
      }

      document.getElementById('refresh').onclick = render;
      render();
    })();
  </script>
</body>
</html>
